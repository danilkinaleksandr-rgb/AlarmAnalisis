<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Универсальный анализатор логов БС</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-width: 1400px;
        }
        
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* HEADER */
        .header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .logo p {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .header-stats {
            display: flex;
            gap: 25px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* UPLOAD SECTION */
        .upload-section {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: initial;
            height: auto;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .file-card {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            background-color: #f8f9ff;
        }
        
        .file-card:hover {
            border-color: #1a237e;
            background-color: #eef1ff;
        }
        
        .file-card h3 {
            margin-bottom: 15px;
            color: #1a237e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .file-requirements {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
        }
        
        .file-requirements ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        /* TABS */
        .tabs-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab-btn {
            padding: 18px 30px;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #495057;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab-btn:hover {
            background: #e9ecef;
            color: #1a237e;
        }
        
        .tab-btn.active {
            background: white;
            color: #1a237e;
            border-bottom: 3px solid #1a237e;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* MONITORING STYLES */
        .monitoring-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .monitoring-stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid;
        }
        
        .stat-card-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stat-card-subvalue {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        /* Горизонтальное отображение регионов */
        .regions-horizontal {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 20px;
            padding: 10px 0;
            min-height: 600px;
        }
        
        .region-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 1px solid #eaeaea;
            flex: 0 0 auto;
            width: 350px;
            min-height: 550px;
        }
        
        .region-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .region-header h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .region-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .center-group {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .center-group:last-child {
            border-bottom: none;
        }
        
        .center-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
        }
        
        .status-card {
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .status-card-header {
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .status-card-header:hover {
            background-color: #f8f9fa;
        }
        
        .status-card.disconnected .status-card-header {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .status-card.battery .status-card-header {
            background-color: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ef6c00;
        }
        
        .status-card.no-mpf .status-card-header {
            background-color: #e8eaf6;
            color: #3949ab;
            border-left: 4px solid #3949ab;
        }
        
        /* ИЗМЕНЕНИЕ: Убираем фиксированную высоту, делаем скролл */
        .bs-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #fafafa;
            display: none;
        }
        
        .bs-list.expanded {
            display: block;
        }
        
        .bs-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .bs-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1a237e;
        }
        
        .bs-details {
            font-size: 0.85rem;
            color: #666;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        
        /* ALARM ANALYSIS STYLES */
        .analysis-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        /* НОВЫЙ СТИЛЬ ДЛЯ КАСТОМНОГО МУЛЬТИСЕЛЕКТА */
        .custom-multiselect {
            position: relative;
            width: 100%;
        }
        
        .multiselect-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .multiselect-select:hover {
            border-color: #1a237e;
        }
        
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .multiselect-dropdown.show {
            display: block;
        }
        
        .multiselect-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .multiselect-item:hover {
            background-color: #f8f9fa;
        }
        
        .multiselect-item input[type="checkbox"] {
            margin: 0;
        }
        
        .multiselect-item span {
            flex: 1;
        }
        
        .selected-items {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .selected-item {
            background: #e3f2fd;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-item button {
            background: none;
            border: none;
            color: #1565c0;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
        }
        
        /* Стили для мультиселекта - СТАРЫЙ (оставляем для совместимости) */
        select[multiple] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            height: 120px;
            display: none; /* Скрываем старый селект */
        }
        
        /* ИЗМЕНЕНИЕ: Делаем списки аварий скроллящимися */
        .alarm-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 25px;
        }
        
        .category-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #eaeaea;
            max-height: 800px;
            display: flex;
            flex-direction: column;
        }
        
        .category-header {
            padding: 20px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #eaeaea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .category-count {
            background: #1a237e;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .alarms-container {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            display: none;
        }
        
        .alarms-container.expanded {
            display: block;
        }
        
        .bs-alarm-group {
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .bs-alarm-header {
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .bs-alarm-name {
            font-weight: 600;
            color: #1a237e;
        }
        
        .alarm-items {
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alarm-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: white;
            border-left: 4px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alarm-info {
            flex: 1;
        }
        
        .alarm-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .alarm-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .alarm-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .alarm-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .status-uncleared {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-cleared {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        /* DETAILED ANALYTICS STYLES */
        .analytics-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .analytics-tab {
            padding: 12px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: #495057;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .analytics-tab:hover {
            color: #1a237e;
        }
        
        .analytics-tab.active {
            color: #1a237e;
            border-bottom: 3px solid #1a237e;
        }
        
        .analytics-content {
            display: none;
        }
        
        .analytics-content.active {
            display: block;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .table-container h3 {
            margin-bottom: 20px;
            color: #1a237e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: 600;
            color: #1a237e;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* ИЗМЕНЕНИЕ: Таблицы с прокруткой */
        .table-scroll-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .table-scroll-container table {
            margin-bottom: 0;
        }
        
        /* BUTTONS */
        .btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #c62828 0%, #e53935 100%);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .export-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* LOADER */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a237e;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* MESSAGES */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .message.error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        .message.info {
            background-color: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }
        
        /* CONSTRUCTOR MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1400px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .modal-header h3 {
            color: #1a237e;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: #1a237e;
        }
        
        .constructor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .constructor-category {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            background-color: #fafafa;
            min-height: 400px;
            transition: all 0.3s;
        }
        
        .constructor-category.drag-over {
            border-color: #1a237e;
            background-color: #e8eaf6;
        }
        
        .constructor-category h4 {
            color: #1a237e;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .constructor-alarm-list {
            min-height: 300px;
        }
        
        .constructor-alarm-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .constructor-alarm-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .constructor-alarm-item.dragging {
            opacity: 0.5;
        }
        
        .alarm-id {
            background-color: #1a237e;
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .alarm-name-small {
            font-size: 0.85rem;
            flex: 1;
            margin-left: 10px;
            line-height: 1.3;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }
        
        /* NO DATA */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #777;
        }
        
        .no-data i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .no-data h3 {
            margin-bottom: 10px;
            color: #555;
        }
        
        /* Кнопки для мультиселектов */
        .multi-select-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .multi-select-btn {
            padding: 3px 8px;
            font-size: 0.75rem;
            background: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .multi-select-btn:hover {
            background: #e9ecef;
        }
        
        /* Стили для конструктора информации по БС */
        .bs-info-constructor-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .bs-info-constructor-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1400px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .bs-info-constructor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .bs-info-constructor-header h3 {
            color: #1a237e;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bs-info-constructor-close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .bs-info-constructor-close-btn:hover {
            color: #1a237e;
        }
        
        .bs-info-constructor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .bs-info-field-category {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            background-color: #fafafa;
            min-height: 400px;
            transition: all 0.3s;
        }
        
        .bs-info-field-category.available {
            border-color: #1a237e;
            background-color: #e8eaf6;
        }
        
        .bs-info-field-category.selected {
            border-color: #4caf50;
            background-color: #e8f5e9;
        }
        
        .bs-info-field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .bs-info-field-header h4 {
            color: #1a237e;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bs-info-field-list {
            min-height: 300px;
        }
        
        .bs-info-field-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .bs-info-field-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .bs-info-field-item.dragging {
            opacity: 0.5;
        }
        
        .field-name {
            font-weight: 500;
            color: #1a237e;
        }
        
        .field-actions {
            display: flex;
            gap: 5px;
        }
        
        .field-action-btn {
            background: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .field-action-btn:hover {
            background: #e9ecef;
        }
        
        .bs-info-constructor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }
        
        /* Стили для карты */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-zoom-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .map-zoom-button {
            width: 30px;
            height: 30px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .map-zoom-button:hover {
            background: #f5f5f5;
        }
        
        .map-height-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .map-height-button {
            width: 30px;
            height: 30px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .map-height-button:hover {
            background: #f5f5f5;
        }
        
        .map-zoom-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .map-zoom-button {
            width: 30px;
            height: 30px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .map-zoom-button:hover {
            background: #f5f5f5;
        }
        
        .map-search {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .map-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }
        
        .map-search-result-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .map-search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .marker-cluster {
            background-color: rgba(156, 39, 176, 0.6);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .marker-cluster div {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #9c27b0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1600px) {
            body { min-width: auto; }
            .container { max-width: 100%; }
            .regions-horizontal { flex-wrap: wrap; }
            .region-card { width: 100%; }
            .alarm-categories { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 1200px) {
            .upload-grid { grid-template-columns: 1fr; }
            .constructor-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; text-align: center; }
            .header-stats { width: 100%; justify-content: center; flex-wrap: wrap; }
            .tabs-header { flex-direction: column; }
            .tab-btn { width: 100%; justify-content: center; }
            .analytics-tabs { flex-direction: column; }
            .analytics-tab { width: 100%; justify-content: center; }
            .constructor-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; margin: 1% auto; padding: 15px; }
            .regions-horizontal { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-satellite-dish"></i>
                <div>
                    <h1>Универсальный анализатор логов БС</h1>
                    <p>Мониторинг, анализ и категоризация аварийных событий</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-value" id="totalAlarmsStat">0</span>
                    <span class="stat-label">Всего аварий</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="unclearedAlarmsStat">0</span>
                    <span class="stat-label">Не устранено</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="affectedBSStat">0</span>
                    <span class="stat-label">Поражено БС</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="criticalAlarmsStat">0</span>
                    <span class="stat-label">Критические</span>
                </div>
            </div>
        </div>

        <!-- UPLOAD SECTION -->
        <div class="upload-section">
            <h2><i class="fas fa-file-upload"></i> Загрузка файлов</h2>
            <div class="upload-grid">
                <div class="file-card">
                    <h3><i class="fas fa-file-excel"></i> Основной файл аварий (обязательно)</h3>
                    <input type="file" id="alarmFile" class="file-input" accept=".xlsx, .xls, .csv">
                    <div class="file-requirements">
                        <p><strong>Ожидаемые колонки:</strong> Alarm ID, Name, Severity, BBU Name, Clearance Status, First Occurred, Last Occurred</p>
                    </div>
                </div>
                <div class="file-card">
                    <h3><i class="fas fa-database"></i> Файл информации о БС (опционально)</h3>
                    <input type="file" id="bsInfoFile" class="file-input" accept=".xlsx, .xls, .csv">
                    <div class="file-requirements">
                        <p><strong>Для расширенного мониторинга:</strong></p>
                        <ul>
                            <li>Site name - название БС</li>
                            <li>ЦЭ - центр эксплуатации</li>
                            <li>Адрес расположения - физический адрес</li>
                            <li>Операционный статус - статус БС</li>
                            <li>KAT TS - категория</li>
                            <li>Вид трансмиссии - тип транспорта</li>
                            <li>Признак - тип БС</li>
                            <li>WGS широта, гг - широта</li>
                            <li>WGS долгота, гг - долгота</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 15px;">
                <button id="analyzeBtn" class="btn btn-primary">
                    <i class="fas fa-play-circle"></i> Анализировать файлы
                </button>
                <button id="constructorBtn" class="btn btn-warning">
                    <i class="fas fa-cogs"></i> Конструктор категорий
                </button>
                <button id="bsInfoConstructorBtn" class="btn btn-info">
                    <i class="fas fa-table"></i> Конструктор информации по БС
                </button>
                <button id="exportAllBtn" class="btn btn-success" disabled>
                    <i class="fas fa-file-excel"></i> Экспорт всех данных
                </button>
            </div>
            <div class="loader" id="loader"></div>
            <div id="statusMessage" class="message"></div>
        </div>

        <!-- MAIN TABS -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="monitoring">
                    <i class="fas fa-tachometer-alt"></i> Мониторинг БС
                </button>
                <button class="tab-btn" data-tab="alarmAnalysis">
                    <i class="fas fa-chart-bar"></i> Анализ аварий
                </button>
                <button class="tab-btn" data-tab="detailedAnalytics">
                    <i class="fas fa-chart-line"></i> Детальная аналитика
                </button>
                <button class="tab-btn" data-tab="map">
                    <i class="fas fa-map-marked-alt"></i> Карта
                </button>
            </div>

            <!-- MONITORING TAB -->
            <div id="monitoring" class="tab-content active">
                <div class="no-data" id="monitoringNoData">
                    <i class="fas fa-satellite-dish"></i>
                    <h3>Для мониторинга требуется файл информации о БС</h3>
                    <p>Загрузите оба файла для отображения данных мониторинга</p>
                </div>
                <div id="monitoringContent" style="display: none;">
                    <div class="monitoring-stats" id="monitoringStats"></div>
                    <div class="analysis-filters">
                        <div class="filter-group">
                            <label><i class="fas fa-map-marker-alt"></i> Регион</label>
                            <div class="custom-multiselect" id="regionFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('regionFilter', event)">
                                    <span>Выберите регионы</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="regionFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="regionFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('regionFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('regionFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-building"></i> ЦЭ (Центр эксплуатации)</label>
                            <div class="custom-multiselect" id="centerFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('centerFilter', event)">
                                    <span>Выберите центры</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="centerFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="centerFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('centerFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('centerFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-filter"></i> Тип аварии</label>
                            <div class="custom-multiselect" id="alarmTypeFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('alarmTypeFilter', event)">
                                    <span>Выберите типы</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="alarmTypeFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="alarmTypeFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('alarmTypeFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('alarmTypeFilter')">Очистить</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <button onclick="updateMonitoring()" class="btn">
                                <i class="fas fa-filter"></i> Применить фильтры
                            </button>
                            <button onclick="exportMonitoringData()" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Экспорт данных мониторинга
                            </button>
                            <button onclick="showMonitoringOnMap()" class="btn btn-info">
                                <i class="fas fa-map-marked-alt"></i> Показать на карте
                            </button>
                        </div>
                    </div>
                    <div id="regionsContainer" class="regions-horizontal"></div>
                </div>
            </div>

            <!-- ALARM ANALYSIS TAB -->
            <div id="alarmAnalysis" class="tab-content">
                <div class="no-data" id="analysisNoData">
                    <i class="fas fa-file-excel"></i>
                    <h3>Загрузите файл аварий для анализа</h3>
                    <p>Выберите основной файл аварий и нажмите "Анализировать файлы"</p>
                </div>
                <div id="analysisContent" style="display: none;">
                    <div class="analysis-filters">
                        <div class="filter-group">
                            <label><i class="fas fa-map-marker-alt"></i> Регион</label>
                            <div class="custom-multiselect" id="analysisRegionFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('analysisRegionFilter', event)">
                                    <span>Выберите регионы</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="analysisRegionFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="analysisRegionFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('analysisRegionFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('analysisRegionFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-building"></i> ЦЭ (Центр эксплуатации)</label>
                            <div class="custom-multiselect" id="analysisCenterFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('analysisCenterFilter', event)">
                                    <span>Выберите центры</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="analysisCenterFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="analysisCenterFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('analysisCenterFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('analysisCenterFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-exclamation-circle"></i> Критичность</label>
                            <div class="custom-multiselect" id="severityFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('severityFilter', event)">
                                    <span>Выберите критичности</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="severityFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="severityFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('severityFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('severityFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-flag"></i> Статус</label>
                            <div class="custom-multiselect" id="statusFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('statusFilter', event)">
                                    <span>Выберите статусы</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="statusFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="statusFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('statusFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('statusFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-tags"></i> Категории аварий</label>
                            <div class="custom-multiselect" id="analysisCategoryFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('analysisCategoryFilter', event)">
                                    <span>Выберите категории</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="analysisCategoryFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="analysisCategoryFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('analysisCategoryFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('analysisCategoryFilter')">Очистить</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <button onclick="updateAlarmAnalysis()" class="btn">
                                <i class="fas fa-filter"></i> Применить
                            </button>
                            <button onclick="exportFilteredExcel()" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Экспорт в Excel
                            </button>
                            <button id="showFilteredOnMapBtn" class="btn btn-info">
                                <i class="fas fa-map-marked-alt"></i> Показать на карте
                            </button>
                        </div>
                    </div>
                    <div id="alarmCategories" class="alarm-categories"></div>
                </div>
            </div>

            <!-- DETAILED ANALYTICS TAB -->
            <div id="detailedAnalytics" class="tab-content">
                <div class="analytics-tabs">
                    <button class="analytics-tab active" data-analytics-tab="cycles">
                        <i class="fas fa-sync-alt"></i> Циклы отключения
                    </button>
                    <button class="analytics-tab" data-analytics-tab="statistics">
                        <i class="fas fa-chart-pie"></i> Статистика по BBU
                    </button>
                    <button class="analytics-tab" data-analytics-tab="disconnected">
                        <i class="fas fa-plug"></i> Отключения без MPF
                    </button>
                    <button class="analytics-tab" data-analytics-tab="repeats">
                        <i class="fas fa-redo"></i> Многоповторки
                    </button>
                    <button class="analytics-tab" data-analytics-tab="bsinfo">
                        <i class="fas fa-info-circle"></i> Информация по БС
                    </button>
                </div>

                <div id="cycles" class="analytics-content active">
                    <div class="table-container">
                        <h3><i class="fas fa-sync-alt"></i> Циклы отключения питания</h3>
                        <div class="export-buttons">
                            <button onclick="exportToExcel('cyclesTable', 'Циклы_отключения')" class="btn">
                                <i class="fas fa-file-excel"></i> Экспорт в Excel
                            </button>
                        </div>
                        <div id="cyclesTable" class="table-scroll-container"></div>
                    </div>
                </div>

                <div id="statistics" class="analytics-content">
                    <div class="table-container">
                        <h3><i class="fas fa-chart-pie"></i> Статистика по BBU Name</h3>
                        <div class="export-buttons">
                            <button onclick="exportToExcel('statsTable', 'Статистика_по_BBU')" class="btn">
                                <i class="fas fa-file-excel"></i> Экспорт в Excel
                            </button>
                        </div>
                        <div id="statsTable" class="table-scroll-container"></div>
                    </div>
                </div>

                <div id="disconnected" class="analytics-content">
                    <div class="table-container">
                        <h3><i class="fas fa-plug"></i> Отключения без потери питания</h3>
                        <div class="export-buttons">
                            <button onclick="exportToExcel('disconnectedTable', 'Отключения_без_MPF')" class="btn">
                                <i class="fas fa-file-excel"></i> Экспорт в Excel
                            </button>
                        </div>
                        <div id="disconnectedTable" class="table-scroll-container"></div>
                    </div>
                </div>

                <div id="repeats" class="analytics-content">
                    <div class="table-container">
                        <h3><i class="fas fa-redo"></i> Анализ многоповторок</h3>
                        <div class="export-buttons">
                            <button onclick="exportToExcel('repeatsTable', 'Анализ_многоповторок')" class="btn">
                                <i class="fas fa-file-excel"></i> Экспорт в Excel
                            </button>
                        </div>
                        <div id="repeatsTable" class="table-scroll-container"></div>
                    </div>
                </div>

                <div id="bsinfo" class="analytics-content">
                    <div class="table-container">
                        <h3><i class="fas fa-info-circle"></i> Информация по базовым станциям</h3>
                        <div class="export-buttons">
                            <button onclick="exportToExcel('bsInfoTable', 'Информация_по_БС')" class="btn">
                                <i class="fas fa-file-excel"></i> Экспорт в Excel
                            </button>
                            <button onclick="exportToKML()" class="btn btn-warning">
                                <i class="fas fa-map-marked-alt"></i> Экспорт в KML
                            </button>
                        </div>
                        <div id="bsInfoTable" class="table-scroll-container"></div>
                    </div>
                </div>
            </div>

            <!-- MAP TAB -->
            <div id="map" class="tab-content">
                <div class="no-data" id="mapNoData">
                    <i class="fas fa-map-marked-alt"></i>
                    <h3>Для отображения карты требуется файл информации о БС</h3>
                    <p>Загрузите файл информации о БС для отображения карты</p>
                </div>
                <div id="mapContent" style="display: none;">
                    <div class="analysis-filters">
                        <div class="filter-group">
                            <label><i class="fas fa-map-marker-alt"></i> Регион</label>
                            <div class="custom-multiselect" id="mapRegionFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('mapRegionFilter', event)">
                                    <span>Выберите регионы</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="mapRegionFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="mapRegionFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('mapRegionFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('mapRegionFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-building"></i> ЦЭ (Центр эксплуатации)</label>
                            <div class="custom-multiselect" id="mapCenterFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('mapCenterFilter', event)">
                                    <span>Выберите центры</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="mapCenterFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="mapCenterFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('mapCenterFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('mapCenterFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-exclamation-circle"></i> Критичность</label>
                            <div class="custom-multiselect" id="mapSeverityFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('mapSeverityFilter', event)">
                                    <span>Выберите критичности</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="mapSeverityFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="mapSeverityFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('mapSeverityFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('mapSeverityFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-flag"></i> Статус аварии</label>
                            <div class="custom-multiselect" id="mapStatusFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('mapStatusFilter', event)">
                                    <span>Выберите статусы</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="mapStatusFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="mapStatusFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('mapStatusFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('mapStatusFilter')">Очистить</button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label><i class="fas fa-filter"></i> Тип отображения</label>
                            <select id="mapDisplayType" class="file-input">
                                <option value="all">Все БС</option>
                                <option value="monitoring">Только мониторинг</option>
                                <option value="analysis">Только анализ аварий</option>
                                <option value="with_alarms">Только с авариями</option>
                                <option value="without_alarms">Без аварий</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label><i class="fas fa-tags"></i> Категории аварий</label>
                            <div class="custom-multiselect" id="mapCategoryFilterContainer">
                                <div class="multiselect-select" onclick="toggleMultiselect('mapCategoryFilter', event)">
                                    <span>Выберите категории</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multiselect-dropdown" id="mapCategoryFilterDropdown">
                                    <!-- Чекбоксы будут добавлены через JS -->
                                </div>
                                <div class="selected-items" id="mapCategoryFilterSelected">
                                    <!-- Выбранные элементы -->
                                </div>
                            </div>
                            <div class="multi-select-actions">
                                <button class="multi-select-btn" onclick="selectAllMultiselect('mapCategoryFilter')">Выбрать все</button>
                                <button class="multi-select-btn" onclick="clearMultiselect('mapCategoryFilter')">Очистить</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <button onclick="updateMap()" class="btn">
                                <i class="fas fa-filter"></i> Применить фильтры
                            </button>
                            <button onclick="showAllBSOnMap()" class="btn btn-warning">
                                <i class="fas fa-eye"></i> Показать все БС
                            </button>
                        </div>
                    </div>
                    <div id="mapContainer" style="width: 100%; height: 600px; border-radius: 10px; overflow: hidden; background-color: #f0f0f0; position: relative;">
                        <div id="leafletMap" style="width: 100%; height: 100%;"></div>
                        <div class="map-height-controls">
                            <button class="map-height-button" onclick="increaseMapHeight()">+</button>
                            <button class="map-height-button" onclick="decreaseMapHeight()">-</button>
                        </div>
                        <div class="map-search-container" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); max-width: 300px; display: flex; flex-direction: column; gap: 10px;">
                            <h4 style="margin: 0 0 5px 0; color: #1a237e;">Поиск БС</h4>
                            <div style="position: relative;">
                                <input type="text" id="mapSearch" class="map-search" placeholder="Поиск БС по имени..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <div id="mapSearchResults" class="map-search-results"></div>
                            </div>
                            <div>
                                <button onclick="clearMapSelection()" class="btn" style="padding: 5px 10px; font-size: 0.9rem; width: 100%;">
                                    <i class="fas fa-times"></i> Очистить выделение
                                </button>
                            </div>
                        </div>
                        <div id="mapLegend" style="position: absolute; bottom: 60px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000;">
                            <h4 style="margin-bottom: 10px; color: #1a237e;">Обозначения</h4>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div style="width: 20px; height: 20px; background-color: #4caf50; border-radius: 50%; margin-right: 10px;"></div>
                                <span>БС в работе</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div style="width: 20px; height: 20px; background-color: #ff9800; border-radius: 50%; margin-right: 10px;"></div>
                                <span>БС на батарейках</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div style="width: 20px; height: 20px; background-color: #f44336; border-radius: 50%; margin-right: 10px;"></div>
                                <span>БС не работает</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div style="width: 20px; height: 20px; background-color: #1a237e; border-radius: 50%; margin-right: 10px; border: 2px solid white; box-shadow: 0 0 0 2px #1a237e;"></div>
                                <span>Выделенные БС</span>
                            </div>
                        </div>
                        <div class="map-zoom-controls" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 5px;">
                            <button class="map-zoom-button" onclick="map.zoomIn()">+</button>
                            <button class="map-zoom-button" onclick="map.zoomOut()">-</button>
                        </div>
                    </div>
                    <div id="mapStats" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div style="text-align: center; margin-top: 40px; color: #666; font-size: 0.9rem; padding: 20px;">
            <p>Универсальный анализатор логов БС | Версия 2.3 | Объединенная система мониторинга и анализа</p>
            <p>© 2025 Телекоммуникационный мониторинг</p>
        </div>
    </div>

    <!-- CONSTRUCTOR MODAL -->
    <div id="constructorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cogs"></i> Конструктор категорий аварий</h3>
                <button class="close-btn" id="closeConstructorBtn">&times;</button>
            </div>
            <div class="message info">
                <i class="fas fa-info-circle"></i> Перетаскивайте аварии между категориями для настройки группировки. Настройки сохраняются автоматически.
            </div>
            <div class="constructor-grid" id="constructorGrid"></div>
            <div class="modal-actions">
                <button id="saveCategoriesBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Сохранить и закрыть
                </button>
                <button id="resetCategoriesBtn" class="btn btn-warning">
                    <i class="fas fa-undo"></i> Сбросить к умолчанию
                </button>
                <button id="cancelConstructorBtn" class="btn">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- BS INFO CONSTRUCTOR MODAL -->
    <div id="bsInfoConstructorModal" class="bs-info-constructor-modal">
        <div class="bs-info-constructor-content">
            <div class="bs-info-constructor-header">
                <h3><i class="fas fa-table"></i> Конструктор информации по БС</h3>
                <button class="bs-info-constructor-close-btn" id="closeBSInfoConstructorBtn">&times;</button>
            </div>
            <div class="message info">
                <i class="fas fa-info-circle"></i> Перетаскивайте поля между доступными и отображаемыми для настройки таблицы информации по БС.
            </div>
            <div class="bs-info-constructor-grid" id="bsInfoConstructorGrid">
                <div class="bs-info-field-category available">
                    <div class="bs-info-field-header">
                        <h4><i class="fas fa-list"></i> Доступные поля</h4>
                    </div>
                    <div class="bs-info-field-list" id="availableFieldsList"></div>
                </div>
                <div class="bs-info-field-category selected">
                    <div class="bs-info-field-header">
                        <h4><i class="fas fa-check-circle"></i> Отображаемые поля</h4>
                    </div>
                    <div class="bs-info-field-list" id="selectedFieldsList"></div>
                </div>
            </div>
            <div class="bs-info-constructor-actions">
                <button id="saveBSInfoFieldsBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Сохранить и закрыть
                </button>
                <button id="resetBSInfoFieldsBtn" class="btn btn-warning">
                    <i class="fas fa-undo"></i> Сбросить к умолчанию
                </button>
                <button id="cancelBSInfoConstructorBtn" class="btn">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Подключаем Leaflet и дополнения -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ===================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И КОНСТАНТЫ =====================
        
        // Основные данные
        let allAlarms = [];           // Все аварии из файла (уже отфильтрованные по статусу)
        let bbuInfoMap = {};          // Информация о БС (если файл загружен)
        let processedData = null;     // Обработанные данные для мониторинга
        
        // Для мониторинга
        let cycles = [];              // Циклы отключения питания
        let regionStats = {};         // Статистика по регионам
        
        // Для анализа аварий
        let alarmCategories = {};     // Категории аварий
        let alarmTypeMapping = {};    // Маппинг типов аварий на категории
        let filteredAlarms = [];      // Отфильтрованные аварии для анализа
        
        // Для карты
        let map = null;
        let mapMarkers = [];
        let selectedBSMarkers = [];   // Выделенные БС с анализа аварий
        let mapSearchResultsList = []; // Результаты поиска по БС (переименовано чтобы избежать конфликта)
        let mapDisplayMode = 'all';   // Режим отображения карты: 'all', 'monitoring', 'analysis'
        
        // Настройки
        const regionMapping = {
            'SIM': { name: 'Крым', color: '#1a237e' },
            'DON': { name: 'ДНР', color: '#c62828' },
            'LUG': { name: 'ЛНР', color: '#2e7d32' },
            'ARM': { name: 'ХО', color: '#f57c00' },
            'DZH': { name: 'ЗО', color: '#7b1fa2' }
        };
        
        const regionOrder = ['Крым', 'ДНР', 'ЛНР', 'ХО', 'ЗО'];
        
        // Допустимые операционные статусы
        const VALID_OPERATIONAL_STATUSES = ['Эфир', 'Эксплуатируется'];
        
        // Цвета для мониторинга
        const monitoringColors = {
            'disconnected': '#f44336', // Красный
            'battery': '#ff9800',     // Оранжевый
            'working': '#4caf50',     // Зеленый
            'no-mpf': '#3949ab'       // Синий
        };
        
        // Цвета для критичности аварий
        const severityColors = {
            'Critical': '#e53935',
            'Major': '#ff9800',
            'Minor': '#fdd835',
            'Warning': '#42a5f5'
        };
        
        // Категории аварий по умолчанию (сокращенная версия для примера)
        const defaultAlarmCategories = {
            'cell_problems': {
                name: 'Проблемы с сотами',
                icon: 'fas fa-tower-cell',
                color: '#039be5',
                description: 'Все проблемы с GSM, UMTS, LTE сотами'
            },
            'power': {
                name: 'Проблемы с питанием',
                icon: 'fas fa-bolt',
                color: '#e53935',
                description: 'Проблемы с электропитанием, батареями, выпрямителями'
            },
            'bs_not_working': {
                name: 'Неработающие БС',
                icon: 'fas fa-tower-broadcast',
                color: '#43a047',
                description: 'БС не работают, отключены, нет соединения'
            },
            'other': {
                name: 'Другие аварии',
                icon: 'fas fa-question-circle',
                color: '#757575',
                description: 'Аварии без определенной категории'
            }
        };
        
        // Маппинг аварий по умолчанию (основные типы)
        const defaultAlarmTypeMapping = {
            '40012': { name: 'NE Is Disconnected', category: 'bs_not_working', subcategory: 'bs_not_working', icon: 'fas fa-tower-broadcast' },
            '65101': { name: 'Mains Power Failure', category: 'power', subcategory: 'power', icon: 'fas fa-bolt' },
            '65102': { name: 'Battery Mode', category: 'power', subcategory: 'power', icon: 'fas fa-car-battery' },
            '29245': { name: 'Cell Blocked', category: 'cell_problems', subcategory: 'cell_problems', icon: 'fas fa-ban' },
            '21802': { name: 'GSM Cell Manually Blocked', category: 'cell_problems', subcategory: 'cell_problems', icon: 'fas fa-user-slash' },
            'default': { name: 'Other Alarm', category: 'other', subcategory: 'other', icon: 'fas fa-exclamation-circle' }
        };
        
        // Мультиселекты данные
        const multiselects = {};
        
        // ===================== ИНИЦИАЛИЗАЦИЯ =====================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Универсальный анализатор логов БС загружен');
            
            // Загружаем сохраненные настройки категорий
            loadSavedSettings();
            
            // Инициализируем обработчики событий
            initEventListeners();
            
            // Инициализируем мультиселекты
            initMultiselects();
            
            // Обновляем опции для фильтра категорий на карте
            updateMapCategoryFilterOptions();
            
            // Закрываем выпадающие списки при клике вне их
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.custom-multiselect')) {
                    closeAllMultiselects();
                }
                // Закрываем результаты поиска
                if (!event.target.closest('#mapSearch') && !event.target.closest('#mapSearchResults')) {
                    document.getElementById('mapSearchResults').style.display = 'none';
                }
            });
        });
        
        function initEventListeners() {
            // Основные кнопки
            document.getElementById('analyzeBtn').addEventListener('click', analyzeFiles);
            document.getElementById('exportAllBtn').addEventListener('click', exportAllData);
            document.getElementById('constructorBtn').addEventListener('click', openConstructor);
            
            // Вкладки
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    openTab(tabId);
                    
                    // При переключении на вкладку карты обновляем размеры карты
                    if (tabId === 'map' && map) {
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 100);
                    }
                });
            });
            
            // Кнопка "Показать на карте" в анализе аварий
            document.getElementById('showFilteredOnMapBtn').addEventListener('click', function() {
                showFilteredOnMap();
            });
            
            // Вкладки детальной аналитики
            document.querySelectorAll('.analytics-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-analytics-tab');
                    openAnalyticsTab(tabId);
                });
            });
            
            // Конструктор категорий
            document.getElementById('closeConstructorBtn').addEventListener('click', closeConstructor);
            document.getElementById('cancelConstructorBtn').addEventListener('click', closeConstructor);
            document.getElementById('saveCategoriesBtn').addEventListener('click', saveCategoriesAndClose);
            document.getElementById('resetCategoriesBtn').addEventListener('click', resetCategories);
            
            // Поиск на карте
            document.getElementById('mapSearch').addEventListener('input', searchBSOnMap);
            document.getElementById('mapSearch').addEventListener('focus', function() {
                if (mapSearchResultsList.length > 0) {
                    document.getElementById('mapSearchResults').style.display = 'block';
                }
            });
        }
        
        // ===================== МУЛЬТИСЕЛЕКТЫ =====================
        
        function initMultiselects() {
            const multiselectIds = [
                'regionFilter', 'centerFilter', 'alarmTypeFilter',
                'analysisRegionFilter', 'analysisCenterFilter', 'analysisCategoryFilter', 'severityFilter', 'statusFilter',
                'mapRegionFilter', 'mapCenterFilter', 'mapSeverityFilter', 'mapStatusFilter', 'mapCategoryFilter'
            ];
            
            multiselectIds.forEach(id => {
                multiselects[id] = {
                    selected: [],
                    options: [],
                    dropdown: document.getElementById(id + 'Dropdown'),
                    selectedContainer: document.getElementById(id + 'Selected')
                };
            });
        }
        
        function toggleMultiselect(multiselectId, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const dropdown = document.getElementById(multiselectId + 'Dropdown');
            const isOpen = dropdown.classList.contains('show');
            
            // Закрываем все выпадающие списки
            closeAllMultiselects();
            
            // Открываем текущий, если был закрыт
            if (!isOpen) {
                dropdown.classList.add('show');
                
                // Обновляем опции, если они еще не загружены или если это фильтр ЦЭ
                if (multiselects[multiselectId].options.length === 0 ||
                    multiselectId.includes('CenterFilter')) {
                    populateMultiselectOptions(multiselectId);
                }
            }
        }
        
        function closeAllMultiselects() {
            document.querySelectorAll('.multiselect-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
        
        function populateMultiselectOptions(multiselectId) {
            const multiselect = multiselects[multiselectId];
            const dropdown = multiselect.dropdown;
            
            // Очищаем дропдаун
            dropdown.innerHTML = '';
            
            // Добавляем опции в зависимости от типа мультиселекта
            switch(multiselectId) {
                case 'regionFilter':
                case 'analysisRegionFilter':
                case 'mapRegionFilter':
                    regionOrder.forEach(region => {
                        addMultiselectOption(multiselectId, region, region);
                    });
                    break;
                    
                case 'centerFilter':
                case 'analysisCenterFilter':
                case 'mapCenterFilter':
                    // Центры будут обновляться динамически из bbuInfoMap
                    const centers = new Set();
                    Object.values(bbuInfoMap).forEach(info => {
                        if (info && info.center) {
                            centers.add(info.center);
                        }
                    });
                    Array.from(centers).sort().forEach(center => {
                        addMultiselectOption(multiselectId, center, center);
                    });
                    break;
                    
                case 'alarmTypeFilter':
                    addMultiselectOption(multiselectId, 'disconnected', 'Лежащие БС');
                    addMultiselectOption(multiselectId, 'battery', 'БС на батарейках');
                    addMultiselectOption(multiselectId, 'no-mpf', 'БС без MPF');
                    break;
                    
                case 'severityFilter':
                case 'mapSeverityFilter':
                    addMultiselectOption(multiselectId, 'Critical', 'Critical');
                    addMultiselectOption(multiselectId, 'Major', 'Major');
                    addMultiselectOption(multiselectId, 'Minor', 'Minor');
                    addMultiselectOption(multiselectId, 'Warning', 'Warning');
                    break;
                    
                case 'statusFilter':
                case 'mapStatusFilter':
                    addMultiselectOption(multiselectId, 'uncleared', 'Не устранено');
                    addMultiselectOption(multiselectId, 'cleared', 'Устранено');
                    break;
                    
                case 'mapCategoryFilter':
                    // Добавляем категории аварий
                    Object.keys(defaultAlarmCategories).forEach(categoryKey => {
                        const category = defaultAlarmCategories[categoryKey];
                        addMultiselectOption(multiselectId, categoryKey, category.name);
                    });
                    break;
            }
            
            // Обновляем выбранные элементы
            updateMultiselectSelected(multiselectId);
        }
        
        function addMultiselectOption(multiselectId, value, label) {
            const multiselect = multiselects[multiselectId];
            const dropdown = multiselect.dropdown;
            
            const isSelected = multiselect.selected.includes(value);
            
            const option = document.createElement('div');
            option.className = 'multiselect-item';
            option.innerHTML = `
                <input type="checkbox" value="${value}" ${isSelected ? 'checked' : ''} 
                       onchange="toggleMultiselectItem('${multiselectId}', '${value}')">
                <span>${label}</span>
            `;
            
            dropdown.appendChild(option);
            multiselect.options.push({ value, label });
        }
        
        // Переименовано чтобы избежать конфликта
        function toggleMultiselectItem(multiselectId, value) {
            const multiselect = multiselects[multiselectId];
            const index = multiselect.selected.indexOf(value);
            
            if (index === -1) {
                multiselect.selected.push(value);
            } else {
                multiselect.selected.splice(index, 1);
            }
            
            updateMultiselectSelected(multiselectId);
        }
        
        function updateMultiselectSelected(multiselectId) {
            const multiselect = multiselects[multiselectId];
            const container = multiselect.selectedContainer;
            const selectElement = document.getElementById(multiselectId + 'Dropdown');
            
            if (!container) return;
            
            // Обновляем контейнер выбранных элементов
            container.innerHTML = '';
            
            if (multiselect.selected.length === 0) {
                container.style.display = 'none';
                const selectBtn = container.closest('.custom-multiselect').querySelector('.multiselect-select span');
                if (selectBtn) selectBtn.textContent = 'Выберите...';
            } else {
                container.style.display = 'flex';
                
                multiselect.selected.forEach(value => {
                    const option = multiselect.options.find(opt => opt.value === value);
                    if (option) {
                        const selectedItem = document.createElement('div');
                        selectedItem.className = 'selected-item';
                        selectedItem.innerHTML = `
                            ${option.label}
                            <button onclick="removeMultiselectItem('${multiselectId}', '${value}')">&times;</button>
                        `;
                        container.appendChild(selectedItem);
                    }
                });
                
                // Обновляем текст кнопки
                const selectBtn = container.closest('.custom-multiselect').querySelector('.multiselect-select span');
                if (selectBtn) {
                    const selectedLabels = multiselect.selected.map(v => {
                        const opt = multiselect.options.find(o => o.value === v);
                        return opt ? opt.label : v;
                    });
                    selectBtn.textContent = selectedLabels.length > 2 ? `Выбрано: ${selectedLabels.length}` : selectedLabels.join(', ');
                }
            }
            
            // Обновляем чекбоксы в дропдауне
            if (selectElement) {
                selectElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = multiselect.selected.includes(checkbox.value);
                });
            }
        }
        
        // Переименовано чтобы избежать конфликта
        function removeMultiselectItem(multiselectId, value) {
            const multiselect = multiselects[multiselectId];
            const index = multiselect.selected.indexOf(value);
            
            if (index !== -1) {
                multiselect.selected.splice(index, 1);
                updateMultiselectSelected(multiselectId);
            }
        }
        
        function selectAllMultiselect(multiselectId) {
            const multiselect = multiselects[multiselectId];
            if (multiselect.options.length === 0) {
                populateMultiselectOptions(multiselectId);
            }
            multiselect.selected = multiselect.options.map(opt => opt.value).filter(v => v !== '');
            updateMultiselectSelected(multiselectId);
        }
        
        function clearMultiselect(multiselectId) {
            const multiselect = multiselects[multiselectId];
            multiselect.selected = [];
            updateMultiselectSelected(multiselectId);
        }
        
        function getMultiselectValues(multiselectId) {
            return multiselects[multiselectId]?.selected || [];
        }
        
        function getUniqueCenters() {
            const centers = new Set();
            
            // Собираем все центры из информации о БС
            Object.values(bbuInfoMap).forEach(info => {
                if (info.center && info.center.trim()) {
                    centers.add(info.center.trim());
                }
            });
            
            return Array.from(centers).sort();
        }
        
        // ===================== ФУНКЦИИ ДЛЯ РАБОТЫ С ДЛИТЕЛЬНОСТЬЮ =====================
        
        function formatDuration(minutes) {
            if (!minutes || minutes < 0) return '0 мин';
            
            if (minutes < 60) {
                return `${Math.round(minutes)} мин`;
            } else if (minutes <= 48 * 60) {
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return `${hours} ч ${mins} мин`;
            } else {
                const days = Math.floor(minutes / (60 * 24));
                const hours = Math.floor((minutes % (60 * 24)) / 60);
                const mins = Math.round(minutes % 60);
                return `${days} дн ${hours} ч ${mins} мин`;
            }
        }
        
        function formatDurationForTable(minutes) {
            if (!minutes || minutes < 0) return '0';
            
            if (minutes < 60) {
                return `${Math.round(minutes)} мин`;
            } else if (minutes < 24 * 60) {
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return `${hours} ч ${mins} мин`;
            } else {
                const days = Math.floor(minutes / (60 * 24));
                const hours = Math.floor((minutes % (60 * 24)) / 60);
                return `${days} дн ${hours} ч`;
            }
        }
        
        // ===================== УЛУЧШЕННЫЙ ПАРСИНГ ДАТЫ =====================
        
        function parseDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            
            const trimmed = dateString.trim();
            if (!trimmed || trimmed === '-' || trimmed === 'NULL' || trimmed === 'N/A' || trimmed === 'null') return null;
            
            // Пробуем стандартный парсинг
            let date = new Date(trimmed);
            if (!isNaN(date.getTime())) return date;
            
            // Формат "2025-12-21 19:41:40"
            const exactMatch = trimmed.match(/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2})$/);
            if (exactMatch) {
                date = new Date(
                    parseInt(exactMatch[1]),
                    parseInt(exactMatch[2]) - 1,
                    parseInt(exactMatch[3]),
                    parseInt(exactMatch[4]),
                    parseInt(exactMatch[5]),
                    parseInt(exactMatch[6])
                );
                if (!isNaN(date.getTime())) return date;
            }
            
            // Формат "2025-12-21 22:13:37"
            const isoMatch = trimmed.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})[, \t]+(\d{1,2}):(\d{1,2}):(\d{1,2})$/);
            if (isoMatch) {
                date = new Date(
                    parseInt(isoMatch[1]),
                    parseInt(isoMatch[2]) - 1,
                    parseInt(isoMatch[3]),
                    parseInt(isoMatch[4]),
                    parseInt(isoMatch[5]),
                    parseInt(isoMatch[6])
                );
                if (!isNaN(date.getTime())) return date;
            }
            
            // Формат "21.12.2025 22:13:37"
            const ruMatch = trimmed.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})[, \t]+(\d{1,2}):(\d{1,2}):(\d{1,2})$/);
            if (ruMatch) {
                date = new Date(
                    parseInt(ruMatch[3]),
                    parseInt(ruMatch[2]) - 1,
                    parseInt(ruMatch[1]),
                    parseInt(ruMatch[4]),
                    parseInt(ruMatch[5]),
                    parseInt(ruMatch[6])
                );
                if (!isNaN(date.getTime())) return date;
            }
            
            // Формат "21-дек-2025 22:13:37"
            const monthMap = {
                'янв': 0, 'фев': 1, 'мар': 2, 'апр': 3, 'май': 4, 'июн': 5,
                'июл': 6, 'авг': 7, 'сен': 8, 'окт': 9, 'ноя': 10, 'дек': 11,
                'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5,
                'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11
            };
            
            const textMatch = trimmed.match(/^(\d{1,2})[-/ \t]+([а-яa-z]{3})[-/ \t]+(\d{4})[, \t]+(\d{1,2}):(\d{1,2}):(\d{1,2})$/i);
            if (textMatch) {
                const month = monthMap[textMatch[2].toLowerCase().substring(0, 3)];
                if (month !== undefined) {
                    date = new Date(
                        parseInt(textMatch[3]),
                        month,
                        parseInt(textMatch[1]),
                        parseInt(textMatch[4]),
                        parseInt(textMatch[5]),
                        parseInt(textMatch[6])
                    );
                    if (!isNaN(date.getTime())) return date;
                }
            }
            
            return null;
        }
        
        // ===================== ОСНОВНЫЕ ФУНКЦИИ =====================
        
        // Анализ загруженных файлов
        async function analyzeFiles() {
            const alarmFile = document.getElementById('alarmFile').files[0];
            const bsInfoFile = document.getElementById('bsInfoFile').files[0];
            
            if (!alarmFile) {
                showMessage('Пожалуйста, выберите основной файл аварий', 'error');
                return;
            }
            
            showLoader(true);
            showMessage('Начинаю анализ файлов...', 'info');
            
            try {
                // Сбрасываем данные
                allAlarms = [];
                bbuInfoMap = {};
                cycles = [];
                processedData = null;
                filteredAlarms = [];
                selectedBSMarkers = [];
                mapDisplayMode = 'all';
                
                // Читаем основной файл аварий
                const alarmData = await readFile(alarmFile);
                if (alarmData) {
                    // Определяем структуру файла и парсим
                    const { headers, dataStartRow, columnMapping } = analyzeFileStructure(alarmData);
                    const rawAlarms = parseAlarmData(alarmData, dataStartRow, columnMapping);
                    
                    // Если есть файл информации о БС, загружаем его и фильтруем аварии
                    if (bsInfoFile) {
                        const bsInfoData = await readFile(bsInfoFile);
                        if (bsInfoData) {
                            const bsInfoStructure = analyzeBSInfoStructure(bsInfoData);
                            bbuInfoMap = parseBSInfoData(bsInfoData, bsInfoStructure.dataStartRow, bsInfoStructure.columnMapping);
                            showMessage(`Загружена информация по ${Object.keys(bbuInfoMap).length} БС`, 'success');
                            
                            // Фильтруем аварии по операционному статусу
                            allAlarms = filterAlarmsByOperationalStatus(rawAlarms);
                            showMessage(`После фильтрации по операционному статусу: ${allAlarms.length} аварий`, 'success');
                            
                            // Вычисляем циклы отключения питания
                            calculatePowerCycles();
                            
                            // Заполняем детальную аналитику
                            fillDetailedAnalytics();
                            
                            // Обновляем центры в фильтрах
                            updateCenterFilterOptions();
                            
                            // Показываем вкладку мониторинга
                            document.getElementById('monitoringNoData').style.display = 'none';
                            document.getElementById('monitoringContent').style.display = 'block';
                            
                            // Показываем вкладку карты
                            document.getElementById('mapNoData').style.display = 'none';
                            document.getElementById('mapContent').style.display = 'block';
                            
                            // Обновляем мониторинг
                            updateMonitoring();
                            
                            // Инициализируем карту
                            initMap();
                        }
                    } else {
                        // Если файла информации о БС нет, используем все аварии без фильтрации
                        allAlarms = rawAlarms;
                        showMessage(`Загружено ${allAlarms.length} аварий (без фильтрации по статусу)`, 'info');
                        
                        // Скрываем мониторинг и карту
                        document.getElementById('monitoringNoData').style.display = 'block';
                        document.getElementById('monitoringContent').style.display = 'none';
                        document.getElementById('mapNoData').style.display = 'block';
                        document.getElementById('mapContent').style.display = 'none';
                    }
                    
                    // Обновляем статистику в шапке
                    updateHeaderStats();
                    
                    // Показываем анализ аварий
                    document.getElementById('analysisNoData').style.display = 'none';
                    document.getElementById('analysisContent').style.display = 'block';
                    
                    // Обновляем фильтры регионов для анализа аварий
                    updateAnalysisRegionFilter();
                    
                    // Обновляем анализ аварий
                    updateAlarmAnalysis();
                    
                    // Активируем кнопку экспорта
                    document.getElementById('exportAllBtn').disabled = false;
                    
                    showMessage('Анализ завершен успешно!', 'success');
                }
            } catch (error) {
                console.error('Ошибка при анализе файлов:', error);
                showMessage(`Ошибка: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        // Фильтрация аварий по операционному статусу
        function filterAlarmsByOperationalStatus(alarms) {
            return alarms.filter(alarm => {
                const bsInfo = bbuInfoMap[alarm.bbuName];
                if (!bsInfo || !bsInfo.operationalStatus) {
                    // Если информации о БС нет или нет статуса, пропускаем аварию
                    return false;
                }
                
                const status = bsInfo.operationalStatus.toString().trim();
                return VALID_OPERATIONAL_STATUSES.some(validStatus => 
                    status.includes(validStatus)
                );
            });
        }
        
        // Чтение файла (Excel/CSV)
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Ошибка при чтении файла'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Анализ структуры файла аварий
        function analyzeFileStructure(jsonData) {
            let headers = [];
            let dataStartRow = 0;
            
            // Ищем строку с заголовками в первых 15 строках
            for (let i = 0; i < Math.min(15, jsonData.length); i++) {
                const row = jsonData[i];
                if (!row || row.length < 5) continue;
                
                const rowString = row.join(' ').toLowerCase();
                if (rowString.includes('alarm') && (rowString.includes('severity') || rowString.includes('bbu') || rowString.includes('name'))) {
                    headers = row;
                    dataStartRow = i + 1;
                    break;
                }
            }
            
            if (headers.length === 0 && jsonData.length > 0) {
                headers = jsonData[0];
                dataStartRow = 1;
            }
            
            // Создаем маппинг столбцов
            const columnMapping = {
                alarmId: findColumnIndex(headers, ['alarm id', 'alarm', 'id']),
                alarmName: findColumnIndex(headers, ['name', 'alarm name', 'alarm']),
                severity: findColumnIndex(headers, ['severity', 'criticality']),
                bbuName: findColumnIndex(headers, ['bbu name', 'bbu', 'enodeb', 'gnodeb', 'ne name', 'site name']),
                clearanceStatus: findColumnIndex(headers, ['clearance status', 'clearance', 'status']),
                firstOccurred: findColumnIndex(headers, ['first occurred', 'first occurred (nt)', 'occurred on', 'occurred', 'first']),
                lastOccurred: findColumnIndex(headers, ['last occurred', 'last occurred (nt)', 'lastoccurred', 'last']),
                clearedOn: findColumnIndex(headers, ['cleared on', 'cleared on (nt)', 'cleared']),
                alarmSource: findColumnIndex(headers, ['alarm source', 'source']),
                subnet: findColumnIndex(headers, ['subnet']),
                neType: findColumnIndex(headers, ['ne type', 'type']),
                moName: findColumnIndex(headers, ['mo name', 'mo']),
                location: findColumnIndex(headers, ['location', 'location information']),
                cellName: findColumnIndex(headers, ['cell name', 'cell']),
                rruName: findColumnIndex(headers, ['rru name', 'rru'])
            };
            
            return { headers, dataStartRow, columnMapping };
        }
        
        // Поиск индекса столбца по возможным названиям
        function findColumnIndex(headers, possibleNames) {
            for (let name of possibleNames) {
                const index = headers.findIndex(header =>
                    header && header.toString().toLowerCase().includes(name.toLowerCase())
                );
                if (index !== -1) return index;
            }
            return -1;
        }
        
        // Парсинг данных аварий с улучшенным парсингом дат
        function parseAlarmData(jsonData, dataStartRow, columnMapping) {
            const dataRows = jsonData.slice(dataStartRow);
            const alarms = [];
            
            dataRows.forEach((row, rowIndex) => {
                try {
                    if (row.length > Math.max(columnMapping.alarmId, columnMapping.bbuName)) {
                        const alarmId = row[columnMapping.alarmId];
                        const bbuName = row[columnMapping.bbuName];
                        
                        if (!alarmId || alarmId === '-' || alarmId === 'NULL' || !bbuName || bbuName === '-') return;
                        
                        const alarm = {
                            alarmId: alarmId.toString().trim(),
                            alarmName: columnMapping.alarmName !== -1 ? (row[columnMapping.alarmName] || '') : '',
                            severity: columnMapping.severity !== -1 ? (row[columnMapping.severity] || '') : '',
                            bbuName: bbuName.toString().trim(),
                            clearanceStatus: columnMapping.clearanceStatus !== -1 ? (row[columnMapping.clearanceStatus] || '') : '',
                            firstOccurred: columnMapping.firstOccurred !== -1 ? (row[columnMapping.firstOccurred] || '') : '',
                            lastOccurred: columnMapping.lastOccurred !== -1 ? (row[columnMapping.lastOccurred] || '') : '',
                            clearedOn: columnMapping.clearedOn !== -1 ? (row[columnMapping.clearedOn] || '') : '',
                            alarmSource: columnMapping.alarmSource !== -1 ? (row[columnMapping.alarmSource] || '') : '',
                            subnet: columnMapping.subnet !== -1 ? (row[columnMapping.subnet] || '') : '',
                            neType: columnMapping.neType !== -1 ? (row[columnMapping.neType] || '') : '',
                            moName: columnMapping.moName !== -1 ? (row[columnMapping.moName] || '') : '',
                            location: columnMapping.location !== -1 ? (row[columnMapping.location] || '') : '',
                            cellName: columnMapping.cellName !== -1 ? (row[columnMapping.cellName] || '') : '',
                            rruName: columnMapping.rruName !== -1 ? (row[columnMapping.rruName] || '') : '',
                            rowIndex: alarms.length
                        };
                        
                        // Определяем регион
                        alarm.region = getRegionFromBBU(alarm.bbuName) || getRegionFromSource(alarm.alarmSource) || getRegionFromSubnet(alarm.subnet) || 'Не определен';
                        
                        // Определяем категорию аварии (но не перезаписываем оригинальное название)
                        const alarmType = alarmTypeMapping[alarm.alarmId] || alarmTypeMapping['default'];
                        alarm.category = alarmType.category;
                        alarm.subcategory = alarmType.subcategory;
                        alarm.icon = alarmType.icon;
                        // alarmName остается оригинальным из файла
                        
                        alarms.push(alarm);
                    }
                } catch (error) {
                    console.warn(`Ошибка парсинга строки ${rowIndex + dataStartRow}:`, error);
                }
            });
            
            return alarms;
        }
        
        // Анализ структуры файла информации о БС (с новыми названиями столбцов)
        function analyzeBSInfoStructure(jsonData) {
            let headers = [];
            let dataStartRow = 0;
            
            for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                const row = jsonData[i];
                if (!row || row.length < 2) continue;
                
                const rowString = row.join(' ').toLowerCase();
                if (rowString.includes('site') && (rowString.includes('адрес') || rowString.includes('цэ') || rowString.includes('операционный') || rowString.includes('status'))) {
                    headers = row;
                    dataStartRow = i + 1;
                    break;
                }
            }
            
            if (headers.length === 0 && jsonData.length > 0) {
                headers = jsonData[0];
                dataStartRow = 1;
            }
            
            // Обновленные названия столбцов согласно требованиям
            const columnMapping = {
                bbuName: findColumnIndex(headers, ['Site name', 'site name', 'bbu name', 'bbu', 'enodeb', 'gnodeb', 'ne name', 'name', 'site']),
                address: findColumnIndex(headers, ['Адрес расположения', 'адрес расположения', 'address', 'адрес', 'location']),
                category: findColumnIndex(headers, ['KAT TS', 'kat ts', 'category', 'категория', 'critical']),
                transportType: findColumnIndex(headers, ['Вид трансмиссии', 'вид трансмиссии', 'transport type', 'transport', 'тип транспорта']),
                center: findColumnIndex(headers, ['ЦЭ', 'цэ', 'center', 'центр эксплуатации', 'region']),
                bsType: findColumnIndex(headers, ['Признак', 'признак', 'bs type', 'type', 'тип бс']),
                batteryCapacity: findColumnIndex(headers, ['battery capacity', 'battery', 'акб', 'емкость акб']),
                latitude: findColumnIndex(headers, ['WGS широта, гг', 'wgs широта, гг', 'latitude', 'lat', 'широта']),
                longitude: findColumnIndex(headers, ['WGS долгота, гг', 'wgs долгота, гг', 'longitude', 'lon', 'lng', 'долгота']),
                operationalStatus: findColumnIndex(headers, ['Операционный статус', 'операционный статус', 'operational status', 'статус'])
            };
            
            return { headers, dataStartRow, columnMapping };
        }
        
        // Парсинг информации о БС с новыми названиями столбцов
        function parseBSInfoData(jsonData, dataStartRow, columnMapping) {
            const dataRows = jsonData.slice(dataStartRow);
            const bsInfoMap = {};
            
            dataRows.forEach((row, rowIndex) => {
                try {
                    if (row.length > columnMapping.bbuName) {
                        const bbuName = row[columnMapping.bbuName];
                        if (!bbuName || bbuName === '-' || bbuName === 'NULL' || bbuName === 'null') return;
                        
                        const info = {
                            bbuName: bbuName.toString().trim()
                        };
                        
                        if (columnMapping.address !== -1) info.address = row[columnMapping.address] || '';
                        if (columnMapping.category !== -1) info.category = row[columnMapping.category] || '';
                        if (columnMapping.transportType !== -1) info.transportType = row[columnMapping.transportType] || '';
                        if (columnMapping.center !== -1) info.center = row[columnMapping.center] || '';
                        if (columnMapping.bsType !== -1) info.bsType = row[columnMapping.bsType] || '';
                        if (columnMapping.batteryCapacity !== -1) {
                            const batteryVal = row[columnMapping.batteryCapacity];
                            info.batteryCapacity = parseInt(batteryVal) || 180;
                        }
                        if (columnMapping.latitude !== -1) {
                            const lat = parseFloat(row[columnMapping.latitude]);
                            if (!isNaN(lat)) info.latitude = lat;
                        }
                        if (columnMapping.longitude !== -1) {
                            const lon = parseFloat(row[columnMapping.longitude]);
                            if (!isNaN(lon)) info.longitude = lon;
                        }
                        if (columnMapping.operationalStatus !== -1) info.operationalStatus = row[columnMapping.operationalStatus] || '';
                        
                        bsInfoMap[info.bbuName] = info;
                    }
                } catch (error) {
                    console.warn(`Ошибка парсинга строки БС ${rowIndex + dataStartRow}:`, error);
                }
            });
            
            return bsInfoMap;
        }
        
        // ===================== ФУНКЦИИ МОНИТОРИНГА =====================
        
        // Расчет циклов отключения питания
        function calculatePowerCycles() {
            cycles = [];
            
            // Группируем аварии по BBU
            const bbuGroups = {};
            allAlarms.forEach(alarm => {
                if (!bbuGroups[alarm.bbuName]) bbuGroups[alarm.bbuName] = [];
                bbuGroups[alarm.bbuName].push(alarm);
            });
            
            // Для каждой БС ищем циклы
            Object.keys(bbuGroups).forEach(bbuName => {
                const bbuCycles = findPowerCycles(bbuGroups[bbuName], bbuName);
                cycles.push(...bbuCycles);
            });
        }
        
        // Поиск циклов отключения питания для одной БС
        function findPowerCycles(events, bbuName) {
            const bbuCycles = [];
            
            // Фильтруем события MPF (Mains Power Failure)
            const mpfEvents = events.filter(e =>
                e.alarmName && (e.alarmName.includes('Mains Power Failure') || e.alarmName.includes('Mains Power Failure2')) && isUnclearedAlarm(e)
            ).sort((a, b) => {
                const dateA = parseDate(a.firstOccurred);
                const dateB = parseDate(b.firstOccurred);
                return (dateA || 0) - (dateB || 0);
            });
            
            // Фильтруем события Battery Mode
            const batteryEvents = events.filter(e =>
                e.alarmName && e.alarmName.includes('Battery Mode') && isUnclearedAlarm(e)
            ).sort((a, b) => {
                const dateA = parseDate(a.firstOccurred);
                const dateB = parseDate(b.firstOccurred);
                return (dateA || 0) - (dateB || 0);
            });
            
            // Фильтруем события NE Is Disconnected
            const nidEvents = events.filter(e =>
                e.alarmName && e.alarmName.includes('NE Is Disconnected')
            ).sort((a, b) => {
                const dateA = parseDate(a.firstOccurred);
                const dateB = parseDate(b.firstOccurred);
                return (dateA || 0) - (dateB || 0);
            });
            
            // Строим циклы
            for (let mpfIndex = 0; mpfIndex < mpfEvents.length; mpfIndex++) {
                const mpf = mpfEvents[mpfIndex];
                const mpfTime = parseDate(mpf.firstOccurred);
                if (!mpfTime) continue;
                
                // Ищем соответствующий Battery Mode
                let batteryMode = null;
                for (let bmIndex = 0; bmIndex < batteryEvents.length; bmIndex++) {
                    const bm = batteryEvents[bmIndex];
                    const bmTime = parseDate(bm.firstOccurred);
                    if (!bmTime) continue;
                    
                    const timeDiff = Math.abs(bmTime - mpfTime);
                    if (timeDiff <= 10 * 60 * 1000) { // 10 минут
                        batteryMode = bm;
                        break;
                    }
                }
                
                // Определяем окончание цикла
                let endEvent = null;
                let endType = '';
                let endTime = null;
                
                if (!isUnclearedAlarm(mpf) && mpf.clearedOn && parseDate(mpf.clearedOn)) {
                    endEvent = mpf;
                    endType = 'Power Restored (MPF Cleared)';
                    endTime = parseDate(mpf.clearedOn);
                } else if (batteryMode && !isUnclearedAlarm(batteryMode) && batteryMode.clearedOn && parseDate(batteryMode.clearedOn)) {
                    endEvent = batteryMode;
                    endType = 'Power Restored (BM Cleared)';
                    endTime = parseDate(batteryMode.clearedOn);
                } else {
                    // Ищем NE Is Disconnected после MPF
                    for (let nidIndex = 0; nidIndex < nidEvents.length; nidIndex++) {
                        const nid = nidEvents[nidIndex];
                        const nidTime = parseDate(nid.firstOccurred);
                        if (!nidTime || nidTime <= mpfTime) continue;
                        
                        if (!batteryMode || nidTime > parseDate(batteryMode.firstOccurred)) {
                            const timeToNid = (nidTime - mpfTime) / (1000 * 60 * 60); // часы
                            if (timeToNid <= 48) { // 48 часов
                                endEvent = nid;
                                endType = 'NE Is Disconnected (Battery Exhausted)';
                                endTime = nidTime;
                                break;
                            }
                        }
                    }
                    
                    if (!endEvent && mpfIndex + 1 < mpfEvents.length) {
                        const nextMpf = mpfEvents[mpfIndex + 1];
                        const nextMpfTime = parseDate(nextMpf.firstOccurred);
                        if (nextMpfTime) {
                            const timeBetweenMpf = (nextMpfTime - mpfTime) / (1000 * 60 * 60); // часы
                            if (timeBetweenMpf > 2) { // больше 2 часов
                                endEvent = nextMpf;
                                endType = 'Auto-Restored (Next MPF)';
                                endTime = new Date(mpfTime.getTime() + (2 * 60 * 60 * 1000));
                            }
                        }
                    }
                }
                
                if (!endEvent) {
                    endType = 'Unfinished';
                    endTime = new Date();
                }
                
                // Рассчитываем длительность работы от АКБ
                const batteryDuration = calculateBatteryDuration(mpf, batteryMode, endTime, endType);
                const totalDuration = (endTime - mpfTime) / (1000 * 60); // минуты
                
                bbuCycles.push({
                    bbuName,
                    mpf,
                    batteryMode,
                    endEvent,
                    mpfStart: mpf.firstOccurred,
                    mpfTime: mpfTime,
                    batteryStart: batteryMode ? batteryMode.firstOccurred : null,
                    batteryStartTime: batteryMode ? parseDate(batteryMode.firstOccurred) : null,
                    endTime,
                    endType,
                    batteryDuration,
                    totalDuration,
                    isComplete: endType !== 'Unfinished',
                    region: getRegionFromBBU(bbuName),
                    center: getExploitationCenter(bbuName),
                    category: getCategory(bbuName)
                });
            }
            
            return bbuCycles;
        }
        
        // Расчет длительности работы от АКБ
        function calculateBatteryDuration(mpf, batteryMode, endTime, endType) {
            if (!batteryMode) return 0;
            
            const batteryStart = parseDate(batteryMode.firstOccurred);
            if (!batteryStart) return 0;
            
            if (endType.includes('NE Is Disconnected')) {
                return (endTime - batteryStart) / (1000 * 60); // минуты
            }
            
            if (endType.includes('Power Restored') && batteryMode.clearedOn) {
                const clearedTime = parseDate(batteryMode.clearedOn);
                if (clearedTime) {
                    return (clearedTime - batteryStart) / (1000 * 60); // минуты
                }
            }
            
            return (endTime - batteryStart) / (1000 * 60); // минуты
        }
        
        // Получение лежащих БС (NE Is Disconnected)
        function getDisconnectedBS() {
            const now = new Date();
            const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const disconnectedBS = [];
            
            allAlarms.forEach(alarm => {
                if (alarm.alarmName && alarm.alarmName.includes('NE Is Disconnected')) {
                    if (!isUnclearedAlarm(alarm)) return;
                    
                    const region = getRegionFromBBU(alarm.bbuName);
                    if (!region) return;
                    
                    const center = getExploitationCenter(alarm.bbuName);
                    const eventTime = parseDate(alarm.firstOccurred);
                    if (!eventTime) return;
                    
                    const isRecent24h = eventTime >= twentyFourHoursAgo;
                    const duration = (now - eventTime) / (1000 * 60); // минуты
                    
                    disconnectedBS.push({
                        bbuName: alarm.bbuName,
                        region: region,
                        center: center,
                        category: getCategory(alarm.bbuName),
                        address: getAddress(alarm.bbuName),
                        occurred: alarm.firstOccurred,
                        lastOccurred: alarm.lastOccurred,
                        clearanceStatus: alarm.clearanceStatus || '',
                        eventTime: eventTime,
                        isRecent24h: isRecent24h,
                        duration: duration,
                        durationFormatted: formatDuration(duration),
                        type: 'disconnected'
                    });
                }
            });
            
            return disconnectedBS;
        }
        
        // ===================== ФУНКЦИИ ДЛЯ РАБОТЫ С БАТАРЕЯМИ =====================
        
        // Оценка оставшегося времени работы от АКБ
        function estimateBatteryRemaining(cycle) {
            if (!cycle || !cycle.bbuName) {
                return { estimate: 0, percentage: 100 };
            }
            
            const bbuName = cycle.bbuName;
            const info = bbuInfoMap[bbuName];
            
            // Емкость АКБ по умолчанию 180 минут (3 часа), если не указано
            const batteryCapacity = (info && info.batteryCapacity) || 180;
            
            // Длительность работы от АКБ
            const batteryDuration = cycle.batteryDuration || 0;
            
            // Расчет оставшегося времени
            let remainingTime = batteryCapacity - batteryDuration;
            if (remainingTime < 0) {
                remainingTime = 0;
            }
            
            // Расчет процента использования
            let percentage = 0;
            if (batteryCapacity > 0) {
                percentage = Math.min(100, (batteryDuration / batteryCapacity) * 100);
            }
            
            return {
                estimate: remainingTime,
                percentage: percentage,
                capacity: batteryCapacity,
                used: batteryDuration
            };
        }
        
        // Получение БС на батарейках
        function getBatteryBS() {
            const batteryBS = [];
            const now = new Date();
            
            if (!cycles || cycles.length === 0) return batteryBS;
            
            cycles.forEach(cycle => {
                if (cycle.batteryMode && cycle.endType === 'Unfinished') {
                    const region = getRegionFromBBU(cycle.bbuName);
                    if (!region) return;
                    
                    const center = getExploitationCenter(cycle.bbuName);
                    const remaining = estimateBatteryRemaining(cycle);
                    
                    batteryBS.push({
                        bbuName: cycle.bbuName,
                        region: region,
                        center: center,
                        category: getCategory(cycle.bbuName),
                        address: getAddress(cycle.bbuName),
                        mpfStart: cycle.mpfStart,
                        batteryStart: cycle.batteryMode.firstOccurred,
                        batteryDuration: cycle.batteryDuration,
                        batteryDurationFormatted: formatDuration(cycle.batteryDuration),
                        remainingEstimate: remaining.estimate,
                        remainingFormatted: formatDuration(remaining.estimate),
                        percentage: remaining.percentage,
                        isCritical: remaining.percentage > 80,
                        type: 'battery'
                    });
                }
            });
            
            return batteryBS;
        }
        
        // Получение БС без MPF
        function getNoMPFBS() {
            const disconnectedBS = getDisconnectedBS();
            const now = new Date();
            const twelveHoursAgo = new Date(now.getTime() - 12 * 60 * 60 * 1000);
            const noMPFBS = [];
            
            // Группируем события по BBU
            const bbuEvents = {};
            allAlarms.forEach(alarm => {
                if (!bbuEvents[alarm.bbuName]) bbuEvents[alarm.bbuName] = [];
                bbuEvents[alarm.bbuName].push(alarm);
            });
            
            disconnectedBS.forEach(disconnected => {
                const bbuName = disconnected.bbuName;
                const events = bbuEvents[bbuName] || [];
                
                // Проверяем наличие MPF за последние 12 часов
                const hasMPF = events.some(alarm =>
                    alarm.alarmName && (alarm.alarmName.includes('Mains Power Failure') || alarm.alarmName.includes('Mains Power Failure2')) &&
                    isUnclearedAlarm(alarm) &&
                    parseDate(alarm.firstOccurred) >= twelveHoursAgo
                );
                
                if (!hasMPF) {
                    noMPFBS.push({
                        bbuName: disconnected.bbuName,
                        region: disconnected.region,
                        center: disconnected.center,
                        category: disconnected.category,
                        address: disconnected.address,
                        occurred: disconnected.occurred,
                        lastOccurred: disconnected.lastOccurred,
                        duration: disconnected.duration,
                        durationFormatted: disconnected.durationFormatted,
                        clearanceStatus: disconnected.clearanceStatus,
                        type: 'no-mpf'
                    });
                }
            });
            
            return noMPFBS;
        }
        
        // Получение БС в работе
        function getWorkingBS() {
            const workingBS = [];
            
            Object.values(bbuInfoMap).forEach(info => {
                if (!info.bbuName) return;
                
                // Проверяем операционный статус
                if (!info.operationalStatus) return;
                const status = info.operationalStatus.toString().trim();
                if (!VALID_OPERATIONAL_STATUSES.some(validStatus => status.includes(validStatus))) {
                    return;
                }
                
                // Проверяем, что БС не в списках проблемных
                const isDisconnected = getDisconnectedBS().some(bs => bs.bbuName === info.bbuName);
                const isOnBattery = getBatteryBS().some(bs => bs.bbuName === info.bbuName);
                const isNoMPF = getNoMPFBS().some(bs => bs.bbuName === info.bbuName);
                
                if (!isDisconnected && !isOnBattery && !isNoMPF) {
                    workingBS.push({
                        bbuName: info.bbuName,
                        region: getRegionFromBBU(info.bbuName),
                        center: info.center,
                        category: info.category,
                        address: info.address,
                        type: 'working'
                    });
                }
            });
            
            return workingBS;
        }
        
        // Обновление мониторинга
        function updateMonitoring() {
            if (!bbuInfoMap || Object.keys(bbuInfoMap).length === 0) return;
            
            const selectedRegions = getMultiselectValues('regionFilter');
            const selectedCenters = getMultiselectValues('centerFilter');
            const selectedAlarmTypes = getMultiselectValues('alarmTypeFilter');
            
            // Обновляем список центров в фильтре
            updateCenterFilterOptions();
            
            // Получаем данные
            const disconnectedBS = getDisconnectedBS();
            const batteryBS = getBatteryBS();
            const noMPFBS = getNoMPFBS();
            
            // Фильтруем данные по выбранным фильтрам
            let filteredDisconnected = disconnectedBS;
            let filteredBattery = batteryBS;
            let filteredNoMPF = noMPFBS;
            
            if (selectedRegions.length > 0) {
                filteredDisconnected = filteredDisconnected.filter(bs => selectedRegions.includes(bs.region));
                filteredBattery = filteredBattery.filter(bs => selectedRegions.includes(bs.region));
                filteredNoMPF = filteredNoMPF.filter(bs => selectedRegions.includes(bs.region));
            }
            
            if (selectedCenters.length > 0) {
                filteredDisconnected = filteredDisconnected.filter(bs => selectedCenters.includes(bs.center));
                filteredBattery = filteredBattery.filter(bs => selectedCenters.includes(bs.center));
                filteredNoMPF = filteredNoMPF.filter(bs => selectedCenters.includes(bs.center));
            }
            
            if (selectedAlarmTypes.length > 0) {
                if (!selectedAlarmTypes.includes('disconnected')) {
                    filteredDisconnected = [];
                }
                if (!selectedAlarmTypes.includes('battery')) {
                    filteredBattery = [];
                }
                if (!selectedAlarmTypes.includes('no-mpf')) {
                    filteredNoMPF = [];
                }
            }
            
            // Обновляем статистику
            updateMonitoringStats(filteredDisconnected, filteredBattery, filteredNoMPF);
            
            // Группируем данные по регионам
            const groupedData = groupDataByRegion(filteredDisconnected, filteredBattery, filteredNoMPF);
            
            // Отображаем регионы (ВСЕГДА все 5 регионов)
            displayRegions(groupedData, selectedRegions, selectedCenters, selectedAlarmTypes);
        }
        
        // Обновление опций фильтра центров
        function updateCenterFilterOptions() {
            const centers = getUniqueCenters();
            
            // Обновляем мультиселект центров для мониторинга
            const multiselect = multiselects['centerFilter'];
            multiselect.options = centers.map(center => ({ value: center, label: center }));
            
            // Перерисовываем дропдаун если он открыт
            if (multiselect.dropdown.classList.contains('show')) {
                populateMultiselectOptions('centerFilter');
            }
            
            // Обновляем выбранные элементы
            updateMultiselectSelected('centerFilter');
            
            // Также обновляем центры для анализа аварий
            const analysisCenterMultiselect = multiselects['analysisCenterFilter'];
            analysisCenterMultiselect.options = centers.map(center => ({ value: center, label: center }));
            
            if (analysisCenterMultiselect.dropdown.classList.contains('show')) {
                populateMultiselectOptions('analysisCenterFilter');
            }
            updateMultiselectSelected('analysisCenterFilter');
            
            // И центры на карте
            const mapCenterMultiselect = multiselects['mapCenterFilter'];
            mapCenterMultiselect.options = centers.map(center => ({ value: center, label: center }));
            
            if (mapCenterMultiselect.dropdown.classList.contains('show')) {
                populateMultiselectOptions('mapCenterFilter');
            }
            updateMultiselectSelected('mapCenterFilter');
        }
        
        // Обновление опций фильтра категорий для анализа
        function updateAnalysisCategoryFilterOptions() {
            // Обновляем мультиселект категорий аварий для анализа
            const analysisCategoryMultiselect = multiselects['analysisCategoryFilter'];
            if (!analysisCategoryMultiselect) {
                // Если элемента еще не существует, создаем его
                multiselects['analysisCategoryFilter'] = {
                    selected: [],
                    options: [],
                    dropdown: document.getElementById('analysisCategoryFilterDropdown'),
                    selectedContainer: document.getElementById('analysisCategoryFilterSelected')
                };
                analysisCategoryMultiselect = multiselects['analysisCategoryFilter'];
            }
            analysisCategoryMultiselect.options = Object.keys(defaultAlarmCategories).map(categoryKey => {
                const category = defaultAlarmCategories[categoryKey];
                return { value: categoryKey, label: category.name };
            });

            if (analysisCategoryMultiselect.dropdown && analysisCategoryMultiselect.dropdown.classList.contains('show')) {
                populateMultiselectOptions('analysisCategoryFilter');
            }
            updateMultiselectSelected('analysisCategoryFilter');
        }
        
        // Обновление опций фильтра категорий аварий на карте
        function updateMapCategoryFilterOptions() {
            // Обновляем мультиселект категорий аварий для карты
            const mapCategoryMultiselect = multiselects['mapCategoryFilter'];
            mapCategoryMultiselect.options = Object.keys(defaultAlarmCategories).map(categoryKey => {
                const category = defaultAlarmCategories[categoryKey];
                return { value: categoryKey, label: category.name };
            });
            
            if (mapCategoryMultiselect.dropdown && mapCategoryMultiselect.dropdown.classList.contains('show')) {
                populateMultiselectOptions('mapCategoryFilter');
            }
            updateMultiselectSelected('mapCategoryFilter');
        }
        
        // Группировка данных по регионам
        function groupDataByRegion(disconnectedBS, batteryBS, noMPFBS) {
            const groupedData = {};
            
            // Инициализируем ВСЕ регионы (даже если нет данных)
            regionOrder.forEach(regionName => {
                groupedData[regionName] = {};
            });
            
            // Группируем лежащие БС
            disconnectedBS.forEach(bs => {
                if (!groupedData[bs.region]) groupedData[bs.region] = {};
                if (!groupedData[bs.region][bs.center]) {
                    groupedData[bs.region][bs.center] = { disconnected: [], battery: [], noMPF: [] };
                }
                groupedData[bs.region][bs.center].disconnected.push(bs);
            });
            
            // Группируем БС на батарейках
            batteryBS.forEach(bs => {
                if (!groupedData[bs.region]) return;
                if (!groupedData[bs.region][bs.center]) {
                    groupedData[bs.region][bs.center] = { disconnected: [], battery: [], noMPF: [] };
                }
                groupedData[bs.region][bs.center].battery.push(bs);
            });
            
            // Группируем БС без MPF
            noMPFBS.forEach(bs => {
                if (!groupedData[bs.region]) return;
                if (!groupedData[bs.region][bs.center]) {
                    groupedData[bs.region][bs.center] = { disconnected: [], battery: [], noMPF: [] };
                }
                groupedData[bs.region][bs.center].noMPF.push(bs);
            });
            
            return groupedData;
        }
        
        // Обновление статистики мониторинга
        function updateMonitoringStats(disconnectedBS, batteryBS, noMPFBS) {
            const totalDisconnected = disconnectedBS.length;
            const recentDisconnected = disconnectedBS.filter(bs => bs.isRecent24h).length;
            const criticalBattery = batteryBS.filter(bs => bs.isCritical).length;
            
            const statsHTML = `
                <div class="monitoring-stat-card" style="border-top-color: #c62828;">
                    <div class="stat-card-title">
                        <i class="fas fa-power-off"></i> Лежащие БС
                    </div>
                    <div class="stat-card-value" style="color: #c62828;">${totalDisconnected}</div>
                    <div class="stat-card-subvalue">За 24ч: ${recentDisconnected}</div>
                </div>
                <div class="monitoring-stat-card" style="border-top-color: #ef6c00;">
                    <div class="stat-card-title">
                        <i class="fas fa-car-battery"></i> БС на батарейках
                    </div>
                    <div class="stat-card-value" style="color: #ef6c00;">${batteryBS.length}</div>
                    <div class="stat-card-subvalue">Критических: ${criticalBattery}</div>
                </div>
                <div class="monitoring-stat-card" style="border-top-color: #3949ab;">
                    <div class="stat-card-title">
                        <i class="fas fa-plug"></i> БС без MPF
                    </div>
                    <div class="stat-card-value" style="color: #3949ab;">${noMPFBS.length}</div>
                    <div class="stat-card-subvalue">Без потери питания</div>
                </div>
                <div class="monitoring-stat-card" style="border-top-color: #1a237e;">
                    <div class="stat-card-title">
                        <i class="fas fa-satellite-dish"></i> Всего БС в базе
                    </div>
                    <div class="stat-card-value" style="color: #1a237e;">${Object.keys(bbuInfoMap).length}</div>
                    <div class="stat-card-subvalue">С допустимым статусом: ${getValidBSCount()}</div>
                </div>
            `;
            
            document.getElementById('monitoringStats').innerHTML = statsHTML;
        }
        
        // Получение количества БС с допустимым статусом
        function getValidBSCount() {
            return Object.values(bbuInfoMap).filter(info => {
                if (!info.operationalStatus) return false;
                const status = info.operationalStatus.toString().trim();
                return VALID_OPERATIONAL_STATUSES.some(validStatus => 
                    status.includes(validStatus)
                );
            }).length;
        }
        
        // Отображение регионов (ВСЕГДА показываем все 5 регионы)
        function displayRegions(groupedData, selectedRegions, selectedCenters, selectedAlarmTypes) {
            const regionsContainer = document.getElementById('regionsContainer');
            let regionsHTML = '';
            
            regionOrder.forEach(region => {
                const centers = groupedData[region] || {};
                const centerKeys = Object.keys(centers);
                
                // Подсчитываем статистику по региону
                let totalDisconnected = 0;
                let totalBattery = 0;
                let totalNoMPF = 0;
                let recentDisconnected = 0;
                
                centerKeys.forEach(center => {
                    const data = centers[center];
                    totalDisconnected += data.disconnected.length;
                    totalBattery += data.battery.length;
                    totalNoMPF += data.noMPF.length;
                    recentDisconnected += data.disconnected.filter(bs => bs.isRecent24h).length;
                });
                
                let regionHTML = '';
                
                // Фильтруем центры
                const filteredCenters = centerKeys.filter(center => {
                    if (selectedCenters.length > 0 && !selectedCenters.includes(center)) {
                        return false;
                    }
                    return true;
                });
                
                if (filteredCenters.length === 0 && centerKeys.length > 0) {
                    // Если нет данных после фильтрации центров, но центры есть
                    regionHTML = `
                        <div class="center-group">
                            <div class="center-header">
                                <span>Нет данных по выбранным фильтрам центров</span>
                            </div>
                        </div>
                    `;
                } else if (filteredCenters.length === 0 && centerKeys.length === 0) {
                    // Если вообще нет данных по региону (но регион всегда показываем)
                    regionHTML = `
                        <div class="center-group">
                            <div class="center-header">
                                <span>Нет данных в регионе</span>
                            </div>
                            <div style="text-align: center; padding: 20px; color: #999;">
                                Нет БС с допустимым статусом в этом регионе
                            </div>
                        </div>
                    `;
                } else {
                    filteredCenters.forEach(center => {
                        const data = centers[center];
                        
                        // Применяем фильтр по типу аварии
                        let filteredDisconnected = data.disconnected;
                        let filteredBattery = data.battery;
                        let filteredNoMPF = data.noMPF;
                        
                        if (selectedAlarmTypes.length > 0) {
                            if (!selectedAlarmTypes.includes('disconnected')) {
                                filteredDisconnected = [];
                            }
                            if (!selectedAlarmTypes.includes('battery')) {
                                filteredBattery = [];
                            }
                            if (!selectedAlarmTypes.includes('no-mpf')) {
                                filteredNoMPF = [];
                            }
                        }
                        
                        // Пропускаем центр если нет данных после фильтрации
                        if (filteredDisconnected.length === 0 && filteredBattery.length === 0 && filteredNoMPF.length === 0) {
                            return;
                        }
                        
                        // Сортируем по длительности (самые долгие сверху)
                        const sortedDisconnected = [...filteredDisconnected].sort((a, b) => b.duration - a.duration);
                        const sortedBattery = [...filteredBattery].sort((a, b) => b.percentage - a.percentage);
                        const sortedNoMPF = [...filteredNoMPF].sort((a, b) => b.duration - a.duration);
                        
                        regionHTML += `
                            <div class="center-group">
                                <div class="center-header">
                                    <span>${center}</span>
                                    <span style="font-size: 0.9rem; color: #666;">
                                        ${filteredDisconnected.length}🟥 ${filteredBattery.length}🔋 ${filteredNoMPF.length}⚡
                                    </span>
                                </div>
                                
                                ${filteredDisconnected.length > 0 ? `
                                <div class="status-card disconnected">
                                    <div class="status-card-header" onclick="toggleBSList(this)">
                                        <span>🟥 Лежащие БС (${filteredDisconnected.length})</span>
                                        <span>${filteredDisconnected.length}</span>
                                    </div>
                                    <div class="bs-list">
                                        ${sortedDisconnected.map(bs => `
                                            <div class="bs-item">
                                                <div class="bs-name">${escapeHtml(bs.bbuName)}</div>
                                                <div class="bs-details">
                                                    <div>${escapeHtml(bs.address || 'Адрес не указан')}</div>
                                                    <div>${escapeHtml(bs.category || 'Категория не указана')}</div>
                                                    <div>🕐 ${bs.durationFormatted}</div>
                                                    <div>${formatDateTime(bs.occurred)}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${filteredBattery.length > 0 ? `
                                <div class="status-card battery">
                                    <div class="status-card-header" onclick="toggleBSList(this)">
                                        <span>🔋 БС на батарейках (${filteredBattery.length})</span>
                                        <span>${filteredBattery.length}</span>
                                    </div>
                                    <div class="bs-list">
                                        ${sortedBattery.map(bs => `
                                            <div class="bs-item">
                                                <div class="bs-name">${escapeHtml(bs.bbuName)}</div>
                                                <div class="bs-details">
                                                    <div>${escapeHtml(bs.address || 'Адрес не указан')}</div>
                                                    <div>${escapeHtml(bs.category || 'Категория не указана')}</div>
                                                    <div>АКБ: ${bs.remainingFormatted}</div>
                                                    <div>${bs.batteryDurationFormatted}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${filteredNoMPF.length > 0 ? `
                                <div class="status-card no-mpf">
                                    <div class="status-card-header" onclick="toggleBSList(this)">
                                        <span>⚡ БС без MPF (${filteredNoMPF.length})</span>
                                        <span>${filteredNoMPF.length}</span>
                                    </div>
                                    <div class="bs-list">
                                        ${sortedNoMPF.map(bs => `
                                            <div class="bs-item">
                                                <div class="bs-name">${escapeHtml(bs.bbuName)}</div>
                                                <div class="bs-details">
                                                    <div>${escapeHtml(bs.address || 'Адрес не указан')}</div>
                                                    <div>${escapeHtml(bs.category || 'Категория не указана')}</div>
                                                    <div>🕐 ${bs.durationFormatted}</div>
                                                    <div>${formatDateTime(bs.occurred)}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }
                
                // Если после фильтрации нет центров для отображения, но регион должен быть показан
                if (!regionHTML) {
                    regionHTML = `
                        <div class="center-group">
                            <div class="center-header">
                                <span>Нет данных по фильтрам</span>
                            </div>
                            <div style="text-align: center; padding: 20px; color: #999;">
                                Нет данных, соответствующих выбранным фильтрам
                            </div>
                        </div>
                    `;
                }
                
                regionsHTML += `
                    <div class="region-card">
                        <div class="region-header">
                            <h3>
                                ${region} 
                                <span class="region-count">
                                    ${totalDisconnected}🟥 ${totalBattery}🔋 ${totalNoMPF}⚡
                                </span>
                            </h3>
                            <div style="font-size: 0.9rem; opacity: 0.9;">
                                За 24ч: ${recentDisconnected} лежащих
                            </div>
                        </div>
                        ${regionHTML}
                    </div>
                `;
            });
            
            regionsContainer.innerHTML = regionsHTML || '<div class="no-data"><p>Нет данных для отображения</p></div>';
        }
        
        // ===================== ФУНКЦИИ АНАЛИЗА АВАРИЙ =====================
        
        // Обновление анализа аварий
        function updateAlarmAnalysis() {
            const selectedRegions = getMultiselectValues('analysisRegionFilter');
            const selectedCenters = getMultiselectValues('analysisCenterFilter');
            const selectedSeverity = getMultiselectValues('severityFilter');
            const selectedStatus = getMultiselectValues('statusFilter');
            const selectedCategories = getMultiselectValues('analysisCategoryFilter');
            
            // Фильтруем аварии
            filteredAlarms = allAlarms.filter(alarm => {
                // Фильтр по региону
                if (selectedRegions.length > 0) {
                    const region = getRegionFromBBU(alarm.bbuName);
                    if (!region || !selectedRegions.includes(region)) return false;
                }
                
                // Фильтр по ЦЭ
                if (selectedCenters.length > 0) {
                    const center = getExploitationCenter(alarm.bbuName);
                    if (!center || !selectedCenters.includes(center)) return false;
                }
                
                // Фильтр по критичности
                if (selectedSeverity.length > 0) {
                    if (!selectedSeverity.includes(alarm.severity)) return false;
                }
                
                // Фильтр по статусу
                if (selectedStatus.length > 0) {
                    if (selectedStatus.includes('uncleared') && !isUnclearedAlarm(alarm)) return false;
                    if (selectedStatus.includes('cleared') && isUnclearedAlarm(alarm)) return false;
                }
                
                // Фильтр по категориям аварий
                if (selectedCategories.length > 0) {
                    const category = alarm.category || 'other';
                    if (!selectedCategories.includes(category)) return false;
                }
                
                return true;
            });
            
            // Обновляем фильтры регионов
            updateAnalysisRegionFilter();
            
            // Обновляем опции фильтра категорий для анализа
            updateAnalysisCategoryFilterOptions();
            
            // Обновляем опции фильтра категорий для карты
            updateMapCategoryFilterOptions();
            
            // Отображаем категории аварий
            displayAlarmCategories();
        }
        
        // Обновление фильтра регионов для анализа
        function updateAnalysisRegionFilter() {
            const regions = new Set();
            allAlarms.forEach(alarm => {
                const region = getRegionFromBBU(alarm.bbuName);
                if (region) regions.add(region);
            });
            
            // Обновляем мультиселект
            const multiselect = multiselects['analysisRegionFilter'];
            multiselect.options = Array.from(regions).map(region => ({ value: region, label: region }));
            
            // Сохраняем текущие выбранные значения
            const currentSelected = [...multiselect.selected];
            
            // Перерисовываем дропдаун
            if (multiselect.dropdown.classList.contains('show')) {
                populateMultiselectOptions('analysisRegionFilter');
            }
            
            // Восстанавливаем выбранные значения, которые все еще доступны
            multiselect.selected = currentSelected.filter(value => 
                multiselect.options.some(opt => opt.value === value)
            );
            
            updateMultiselectSelected('analysisRegionFilter');
        }
        
        // Отображение категорий аварий
        function displayAlarmCategories() {
            const alarmCategoriesContainer = document.getElementById('alarmCategories');
            
            // Группируем аварии по категориям
            const alarmsByCategory = {};
            
            filteredAlarms.forEach(alarm => {
                const category = alarm.category || 'other';
                const subcategory = alarm.subcategory || category;
                
                if (!alarmsByCategory[category]) {
                    alarmsByCategory[category] = {};
                }
                
                if (!alarmsByCategory[category][subcategory]) {
                    alarmsByCategory[category][subcategory] = {};
                }
                
                if (!alarmsByCategory[category][subcategory][alarm.bbuName]) {
                    alarmsByCategory[category][subcategory][alarm.bbuName] = [];
                }
                
                alarmsByCategory[category][subcategory][alarm.bbuName].push(alarm);
            });
            
            let categoriesHTML = '';
            
            // Создаем карточки категорий
            Object.keys(defaultAlarmCategories).forEach(categoryKey => {
                const category = defaultAlarmCategories[categoryKey];
                const subcategories = alarmsByCategory[categoryKey];
                
                if (!subcategories || Object.keys(subcategories).length === 0) return;
                
                // Подсчитываем общее количество аварий в категории
                let totalAlarms = 0;
                Object.values(subcategories).forEach(subcat => {
                    Object.values(subcat).forEach(alarms => {
                        totalAlarms += alarms.length;
                    });
                });
                
                // Создаем HTML для категории
                let categoryHTML = '';
                
                // Группируем по БС
                const allBSAlarms = {};
                Object.values(subcategories).forEach(subcat => {
                    Object.keys(subcat).forEach(bsName => {
                        if (!allBSAlarms[bsName]) {
                            allBSAlarms[bsName] = [];
                        }
                        allBSAlarms[bsName] = allBSAlarms[bsName].concat(subcat[bsName]);
                    });
                });
                
                categoryHTML = renderBSAlarms(allBSAlarms);
                
                if (categoryHTML) {
                    categoriesHTML += `
                        <div class="category-card">
                            <div class="category-header" onclick="toggleCategoryContainer(this)">
                                <div class="category-title">
                                    <div class="category-icon" style="background: ${category.color};">
                                        <i class="${category.icon}"></i>
                                    </div>
                                    <div>
                                        <div>${category.name}</div>
                                        <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                            ${category.description}
                                        </div>
                                    </div>
                                </div>
                                <div class="category-count">${totalAlarms}</div>
                            </div>
                            <div class="alarms-container">
                                ${categoryHTML}
                            </div>
                        </div>
                    `;
                }
            });
            
            alarmCategoriesContainer.innerHTML = categoriesHTML || '<div class="no-data"><p>Нет аварий по выбранным фильтрам</p></div>';
        }
        
        // Рендеринг аварий по БС
        function renderBSAlarms(bsAlarms) {
            let result = '';
            
            Object.keys(bsAlarms).forEach(bsName => {
                const alarms = bsAlarms[bsName];
                
                // Группируем аварии по типу (Alarm ID)
                const alarmsByType = {};
                alarms.forEach(alarm => {
                    if (!alarmsByType[alarm.alarmId]) {
                        alarmsByType[alarm.alarmId] = {
                            name: alarm.alarmName, // Используем ОРИГИНАЛЬНОЕ название из файла
                            icon: alarm.icon || 'fas fa-exclamation-circle',
                            alarms: []
                        };
                    }
                    alarmsByType[alarm.alarmId].alarms.push(alarm);
                });
                
                result += `
                    <div class="bs-alarm-group">
                        <div class="bs-alarm-header" onclick="toggleAlarmsContainer(this)">
                            <div class="bs-alarm-name">${escapeHtml(bsName)}</div>
                            <div style="background: #1a237e; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem;">
                                ${alarms.length}
                            </div>
                        </div>
                        <div class="alarm-items">
                            ${Object.keys(alarmsByType).map(alarmId => {
                                const alarmType = alarmsByType[alarmId];
                                return alarmType.alarms.map(alarm => `
                                    <div class="alarm-item" style="border-left-color: ${getSeverityColor(alarm.severity)};">
                                        <div class="alarm-info">
                                            <div class="alarm-name">
                                                <i class="${alarmType.icon}" style="margin-right: 8px;"></i>
                                                ${escapeHtml(alarmType.name)} (${escapeHtml(alarm.alarmId)})
                                            </div>
                                            <div class="alarm-details">
                                                <div class="alarm-detail">
                                                    <i class="far fa-clock"></i> ${formatDate(alarm.firstOccurred)}
                                                </div>
                                                ${alarm.cellName && alarm.cellName !== '-' ? `
                                                    <div class="alarm-detail">
                                                        <i class="fas fa-tower-cell"></i> ${escapeHtml(alarm.cellName)}
                                                    </div>
                                                ` : ''}
                                                ${alarm.severity ? `
                                                    <div class="alarm-detail">
                                                        <span class="severity-dot" style="background-color: ${getSeverityColor(alarm.severity)};"></span>
                                                        ${escapeHtml(alarm.severity)}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="alarm-status ${isUnclearedAlarm(alarm) ? 'status-uncleared' : 'status-cleared'}">
                                            ${isUnclearedAlarm(alarm) ? 'Не устранено' : 'Устранено'}
                                        </div>
                                    </div>
                                `).join('');
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            return result;
        }
        
        // Показать отфильтрованные аварии на карте
        function showFilteredOnMap() {
            if (filteredAlarms.length === 0) {
                showMessage('Нет данных для отображения на карте', 'warning');
                return;
            }
            
            // Переключаемся на вкладку карты
            openTab('map');
            
            // Устанавливаем режим отображения "анализ аварий"
            mapDisplayMode = 'analysis';
            document.getElementById('mapDisplayType').value = 'analysis';
            
            // Копируем выбранные категории из фильтра анализа в фильтр карты
            const analysisCategoryValues = getMultiselectValues('analysisCategoryFilter');
            if (analysisCategoryValues && analysisCategoryValues.length > 0) {
                const mapCategoryMultiselect = multiselects['mapCategoryFilter'];
                mapCategoryMultiselect.selected = [...analysisCategoryValues];
                updateMultiselectSelected('mapCategoryFilter');
            }
            
            // Обновляем карту
            updateMap();
            
            showMessage(`На карте отображено ${filteredAlarms.length} аварий по выбранным фильтрам`, 'success');
        }
        
        // Показать данные мониторинга на карте
        function showMonitoringOnMap() {
            if (!bbuInfoMap || Object.keys(bbuInfoMap).length === 0) {
                showMessage('Нет данных для отображения на карте', 'warning');
                return;
            }
            
            // Получаем отфильтрованные данные мониторинга
            const selectedRegions = getMultiselectValues('regionFilter');
            const selectedCenters = getMultiselectValues('centerFilter');
            const selectedAlarmTypes = getMultiselectValues('alarmTypeFilter');
            
            const disconnectedBS = getDisconnectedBS();
            const batteryBS = getBatteryBS();
            const noMPFBS = getNoMPFBS();
            const workingBS = getWorkingBS();
            
            // Фильтруем данные по выбранным фильтрам
            let filteredDisconnected = disconnectedBS;
            let filteredBattery = batteryBS;
            let filteredNoMPF = noMPFBS;
            let filteredWorking = workingBS;
            
            if (selectedRegions.length > 0) {
                filteredDisconnected = filteredDisconnected.filter(bs => selectedRegions.includes(bs.region));
                filteredBattery = filteredBattery.filter(bs => selectedRegions.includes(bs.region));
                filteredNoMPF = filteredNoMPF.filter(bs => selectedRegions.includes(bs.region));
                filteredWorking = filteredWorking.filter(bs => selectedRegions.includes(bs.region));
            }
            
            if (selectedCenters.length > 0) {
                filteredDisconnected = filteredDisconnected.filter(bs => selectedCenters.includes(bs.center));
                filteredBattery = filteredBattery.filter(bs => selectedCenters.includes(bs.center));
                filteredNoMPF = filteredNoMPF.filter(bs => selectedCenters.includes(bs.center));
                filteredWorking = filteredWorking.filter(bs => selectedCenters.includes(bs.center));
            }
            
            if (selectedAlarmTypes.length > 0) {
                if (!selectedAlarmTypes.includes('disconnected')) {
                    filteredDisconnected = [];
                }
                if (!selectedAlarmTypes.includes('battery')) {
                    filteredBattery = [];
                }
                if (!selectedAlarmTypes.includes('no-mpf')) {
                    filteredNoMPF = [];
                }
                // Для рабочих БС нет фильтра
            }
            
            // Объединяем все БС
            const allFilteredBS = [
                ...filteredDisconnected,
                ...filteredBattery,
                ...filteredNoMPF,
                ...filteredWorking
            ];
            
            if (allFilteredBS.length === 0) {
                showMessage('Нет данных для отображения на карте по выбранным фильтрам', 'warning');
                return;
            }
            
            // Переключаемся на вкладку карты
            openTab('map');
            
            // Устанавливаем режим отображения "мониторинг"
            mapDisplayMode = 'monitoring';
            document.getElementById('mapDisplayType').value = 'monitoring';
            
            // Обновляем карту
            updateMap();
            
            showMessage(`На карте отображено ${allFilteredBS.length} БС из мониторинга`, 'success');
        }
        
        // Показать все БС на карте
        function showAllBSOnMap() {
            mapDisplayMode = 'all';
            document.getElementById('mapDisplayType').value = 'all';
            updateMap();
            showMessage('Отображены все БС с допустимым статусом', 'info');
        }
        
        // Функция для увеличения высоты карты
        function increaseMapHeight() {
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                const currentHeight = mapContainer.offsetHeight;
                const newHeight = Math.min(currentHeight + 200, 1000); // Не более 1000px
                mapContainer.style.height = newHeight + 'px';
                
                // Обновляем размер карты Leaflet
                if (map) {
                    map.invalidateSize();
                }
            }
        }
        
        // Функция для уменьшения высоты карты
        function decreaseMapHeight() {
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                const currentHeight = mapContainer.offsetHeight;
                const newHeight = Math.max(currentHeight - 200, 400); // Не менее 400px
                mapContainer.style.height = newHeight + 'px';
                
                // Обновляем размер карты Leaflet
                if (map) {
                    map.invalidateSize();
                }
            }
        }
        
        // Функция для уменьшения высоты области загрузки файлов
        function adjustUploadSectionHeight() {
            const uploadSection = document.getElementById('uploadSection');
            if (uploadSection) {
                uploadSection.style.height = 'auto';
                uploadSection.style.minHeight = 'initial';
            }
        }
        
        // ===================== ДЕТАЛЬНАЯ АНАЛИТИКА =====================
        
        // Заполнение детальной аналитики
        function fillDetailedAnalytics() {
            displayCyclesTable();
            displayBBUStatisticsTable();
            displayDisconnectedTable();
            displayBSInfoTable();
            // displayRepeatsTable вызывается отдельно при открытии вкладки
        }
        
        // Отображение таблицы циклов отключения
        function displayCyclesTable() {
            const table = document.getElementById('cyclesTable');
            if (cycles.length === 0) {
                table.innerHTML = '<div class="no-data"><p>Циклы отключения не найдены</p></div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>BBU Name</th>
                            <th>Регион</th>
                            <th>ЦЭ</th>
                            <th>Начало MPF</th>
                            <th>Начало АКБ</th>
                            <th>Окончание</th>
                            <th>Тип окончания</th>
                            <th>Длительность АКБ</th>
                            <th>Общая длительность</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            cycles.forEach(cycle => {
                const batteryStart = cycle.batteryStart ? formatDateTime(cycle.batteryStart) : 'N/A';
                const batteryDurationFormatted = cycle.batteryDuration ? formatDurationForTable(cycle.batteryDuration) : '0';
                const totalDurationFormatted = cycle.totalDuration ? formatDurationForTable(cycle.totalDuration) : '0';
                
                html += `
                    <tr>
                        <td>${escapeHtml(cycle.bbuName)}</td>
                        <td>${escapeHtml(cycle.region || 'N/A')}</td>
                        <td>${escapeHtml(cycle.center || 'N/A')}</td>
                        <td>${formatDateTime(cycle.mpfStart)}</td>
                        <td>${batteryStart}</td>
                        <td>${cycle.endTime ? formatDateTime(cycle.endTime) : 'N/A'}</td>
                        <td>${escapeHtml(cycle.endType)}</td>
                        <td>${batteryDurationFormatted}</td>
                        <td>${totalDurationFormatted}</td>
                        <td>${cycle.isComplete ? 'Завершен' : 'Активен'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
        }
        
        // Отображение статистики по BBU с расширенной информацией
        function displayBBUStatisticsTable() {
            const table = document.getElementById('statsTable');
            
            // Получаем расширенную статистику
            const bbuStats = generateBBUStatisticsWithDetails();
            
            if (bbuStats.length === 0) {
                table.innerHTML = '<div class="no-data"><p>Нет данных для статистики</p></div>';
                return;
            }
            
            // Сортируем по количеству аварий (убывание)
            bbuStats.sort((a, b) => b.totalEvents - a.totalEvents);
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Site name</th>
                            <th>Регион</th>
                            <th>ЦЭ</th>
                            <th>KAT TS</th>
                            <th>Общий простой</th>
                            <th>Работа на АКБ (мин)</th>
                            <th>Работа на АКБ (сред)</th>
                            <th>Работа на АКБ (макс)</th>
                            <th>Кол-во отключений</th>
                            <th>Причина отключения</th>
                            <th>Всего аварий</th>
                            <th>Активных аварий</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            bbuStats.forEach(stat => {
                html += `
                    <tr>
                        <td>${escapeHtml(stat.bbuName)}</td>
                        <td>${escapeHtml(stat.region || 'N/A')}</td>
                        <td>${escapeHtml(stat.center || 'N/A')}</td>
                        <td>${escapeHtml(stat.category)}</td>
                        <td>${stat.totalDowntimeFormatted}</td>
                        <td>${stat.batteryDurationTotalFormatted}</td>
                        <td>${stat.batteryDurationAvgFormatted}</td>
                        <td>${stat.batteryDurationMaxFormatted}</td>
                        <td>${stat.disconnectionCount}</td>
                        <td>${escapeHtml(stat.disconnectionReason)}</td>
                        <td>${stat.totalEvents}</td>
                        <td>${stat.unclearedEvents}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
        }
        
        // Генерация расширенной статистики по BBU
        function generateBBUStatisticsWithDetails() {
            const statsMap = {};
            const now = new Date();
            
            // Инициализация статистики для каждой БС
            Object.keys(bbuInfoMap).forEach(bbuName => {
                const info = bbuInfoMap[bbuName];
                if (!info) return;
                
                statsMap[bbuName] = {
                    bbuName: bbuName,
                    region: getRegionFromBBU(bbuName),
                    center: info.center || '',
                    category: info.category || '',
                    totalDowntime: 0,
                    totalDowntimeFormatted: '0',
                    batteryDurationTotal: 0,
                    batteryDurationTotalFormatted: '0',
                    batteryDurationAvg: 0,
                    batteryDurationAvgFormatted: '0',
                    batteryDurationMax: 0,
                    batteryDurationMaxFormatted: '0',
                    disconnectionCount: 0,
                    disconnectionReason: 'Нет данных',
                    totalEvents: 0,
                    unclearedEvents: 0,
                    firstEvent: '',
                    lastEvent: ''
                };
            });
            
            // Анализируем циклы отключения
            cycles.forEach(cycle => {
                const stat = statsMap[cycle.bbuName];
                if (!stat) return;
                
                stat.disconnectionCount++;
                
                // Время работы на АКБ
                if (cycle.batteryDuration) {
                    stat.batteryDurationTotal += cycle.batteryDuration;
                    stat.batteryDurationMax = Math.max(stat.batteryDurationMax, cycle.batteryDuration);
                }
                
                // Общий простой
                if (cycle.totalDuration) {
                    stat.totalDowntime += cycle.totalDuration;
                }
                
                // Причина отключения
                if (cycle.endType.includes('MPF') || cycle.endType.includes('Power Restored')) {
                    stat.disconnectionReason = 'MPF';
                } else if (cycle.endType.includes('Battery')) {
                    stat.disconnectionReason = 'Battery';
                } else {
                    stat.disconnectionReason = 'Other';
                }
            });
            
            // Анализируем аварии
            allAlarms.forEach(alarm => {
                const stat = statsMap[alarm.bbuName];
                if (!stat) return;
                
                stat.totalEvents++;
                if (isUnclearedAlarm(alarm)) {
                    stat.unclearedEvents++;
                }
                
                // Обновляем первое и последнее событие
                if (!stat.firstEvent || parseDate(alarm.firstOccurred) < parseDate(stat.firstEvent)) {
                    stat.firstEvent = alarm.firstOccurred;
                }
                if (!stat.lastEvent || parseDate(alarm.firstOccurred) > parseDate(stat.lastEvent)) {
                    stat.lastEvent = alarm.firstOccurred;
                }
            });
            
            // Форматируем значения
            Object.values(statsMap).forEach(stat => {
                stat.totalDowntimeFormatted = formatDurationForTable(stat.totalDowntime);
                stat.batteryDurationTotalFormatted = formatDurationForTable(stat.batteryDurationTotal);
                
                if (stat.disconnectionCount > 0) {
                    stat.batteryDurationAvg = stat.batteryDurationTotal / stat.disconnectionCount;
                    stat.batteryDurationAvgFormatted = formatDurationForTable(stat.batteryDurationAvg);
                    stat.batteryDurationMaxFormatted = formatDurationForTable(stat.batteryDurationMax);
                }
            });
            
            return Object.values(statsMap).filter(stat => stat.totalEvents > 0);
        }
        
        // Отображение таблицы отключений без MPF
        function displayDisconnectedTable() {
            const table = document.getElementById('disconnectedTable');
            const noMPFBS = getNoMPFBS();
            
            if (noMPFBS.length === 0) {
                table.innerHTML = '<div class="no-data"><p>Отключений без MPF не найдено</p></div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>BBU Name</th>
                            <th>Регион</th>
                            <th>ЦЭ</th>
                            <th>KAT TS</th>
                            <th>Адрес</th>
                            <th>Время возникновения</th>
                            <th>Длительность</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            noMPFBS.forEach(bs => {
                html += `
                    <tr>
                        <td>${escapeHtml(bs.bbuName)}</td>
                        <td>${escapeHtml(bs.region || 'N/A')}</td>
                        <td>${escapeHtml(bs.center || 'N/A')}</td>
                        <td>${escapeHtml(bs.category || 'N/A')}</td>
                        <td>${escapeHtml(bs.address || 'N/A')}</td>
                        <td>${formatDateTime(bs.occurred)}</td>
                        <td>${bs.durationFormatted}</td>
                        <td>${escapeHtml(bs.clearanceStatus || 'N/A')}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
        }
        
        // Отображение информации по БС с добавлением статуса
        function displayBSInfoTable() {
            updateBSInfoTableWithFields();
        }
        
        // Анализ многоповторок с фильтрами
        function analyzeRepeats(minRepeats = 5, periodDays = 7) {
            const repeats = [];
            const now = new Date();
            const periodStart = new Date(now.getTime() - periodDays * 24 * 60 * 60 * 1000);
            
            const selectedRegions = getMultiselectValues('analysisRegionFilter');
            const selectedCenters = getMultiselectValues('analysisCenterFilter');
            
            const bbuEvents = {};
            allAlarms.forEach(alarm => {
                if (!bbuEvents[alarm.bbuName]) bbuEvents[alarm.bbuName] = [];
                bbuEvents[alarm.bbuName].push(alarm);
            });
            
            Object.entries(bbuEvents).forEach(([bbuName, events]) => {
                // Фильтруем по региону
                const region = getRegionFromBBU(bbuName);
                if (selectedRegions.length > 0 && (!region || !selectedRegions.includes(region))) {
                    return;
                }
                
                // Фильтруем по центру
                const center = getExploitationCenter(bbuName);
                if (selectedCenters.length > 0 && (!center || !selectedCenters.includes(center))) {
                    return;
                }
                
                const periodEvents = events.filter(alarm => {
                    const eventTime = parseDate(alarm.firstOccurred);
                    return eventTime && eventTime >= periodStart;
                });
                
                if (periodEvents.length >= minRepeats) {
                    const alarmTypes = {};
                    periodEvents.forEach(alarm => {
                        if (!alarmTypes[alarm.alarmId]) alarmTypes[alarm.alarmId] = [];
                        alarmTypes[alarm.alarmId].push(alarm);
                    });
                    
                    Object.entries(alarmTypes).forEach(([alarmId, alarmEvents]) => {
                        if (alarmEvents.length >= minRepeats) {
                            const firstTime = parseDate(alarmEvents[0].firstOccurred);
                            const lastTime = parseDate(alarmEvents[alarmEvents.length - 1].firstOccurred);
                            const avgInterval = (lastTime - firstTime) / (alarmEvents.length - 1) / (1000 * 60 * 60);
                            const unclearedCount = alarmEvents.filter(e => isUnclearedAlarm(e)).length;
                            
                            // Используем ОРИГИНАЛЬНОЕ название аварии из alarmName
                            const alarmName = alarmEvents[0].alarmName || `Alarm ${alarmId}`;
                            
                            repeats.push({
                                bbuName: bbuName,
                                region: getRegionFromBBU(bbuName),
                                center: getExploitationCenter(bbuName),
                                category: getCategory(bbuName),
                                alarmName: alarmName,
                                alarmId: alarmId,
                                repeatCount: alarmEvents.length,
                                unclearedCount: unclearedCount,
                                firstOccurrence: formatDateTime(alarmEvents[0].firstOccurred),
                                lastOccurrence: formatDateTime(alarmEvents[alarmEvents.length - 1].firstOccurred),
                                avgInterval: avgInterval.toFixed(1)
                            });
                        }
                    });
                }
            });
            
            repeats.sort((a, b) => b.repeatCount - a.repeatCount);
            return repeats;
        }
        
        // Отображение анализа многоповторок
        function displayRepeatsTable() {
            const table = document.getElementById('repeatsTable');
            const repeats = analyzeRepeats();
            
            if (repeats.length === 0) {
                table.innerHTML = '<div class="no-data"><p>Многоповторок не найдено</p></div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>BBU Name</th>
                            <th>Регион</th>
                            <th>ЦЭ</th>
                            <th>KAT TS</th>
                            <th>Тип аварии</th>
                            <th>Кол-во повторений</th>
                            <th>Активных</th>
                            <th>Первое появление</th>
                            <th>Последнее появление</th>
                            <th>Ср. интервал (часы)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            repeats.forEach(item => {
                html += `
                    <tr>
                        <td>${escapeHtml(item.bbuName)}</td>
                        <td>${escapeHtml(item.region || 'N/A')}</td>
                        <td>${escapeHtml(item.center || 'N/A')}</td>
                        <td>${escapeHtml(item.category)}</td>
                        <td>${escapeHtml(item.alarmName)}</td>
                        <td>${item.repeatCount}</td>
                        <td>${item.unclearedCount}</td>
                        <td>${item.firstOccurrence}</td>
                        <td>${item.lastOccurrence}</td>
                        <td>${item.avgInterval}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            table.innerHTML = html;
        }
        
        // ===================== КАРТА =====================
        
        function initMap() {
            // Проверяем, что контейнер карты существует
            const leafletMapContainer = document.getElementById('leafletMap');
            if (!leafletMapContainer) {
                console.error('Контейнер карты не найден');
                return;
            }
            
            // Если карта уже существует, удаляем ее
            if (map) {
                map.remove();
                mapMarkers = [];
                selectedBSMarkers = [];
            }
            
            // Создаем карту с центром по умолчанию
            map = L.map('leafletMap').setView([49.0, 31.0], 6);
            
            // Добавляем слой OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Обновляем карту после небольшой задержки, чтобы контейнер успел отрисоваться
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    updateMap();
                }
            }, 300);
        }
        
        // Функция для увеличения высоты карты
        function increaseMapHeight() {
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                // Получаем текущую высоту из style или используем высоту по умолчанию
                const currentStyleHeight = mapContainer.style.height;
                let currentHeight = 600; // значение по умолчанию
                
                if (currentStyleHeight && currentStyleHeight.endsWith('px')) {
                    currentHeight = parseInt(currentStyleHeight);
                } else {
                    // Если высота задана через CSS, получаем computed style
                    const computedHeight = window.getComputedStyle(mapContainer).height;
                    if (computedHeight.endsWith('px')) {
                        currentHeight = parseInt(computedHeight);
                    }
                }
                
                const newHeight = Math.min(currentHeight + 200, 1000); // Не более 1000px
                mapContainer.style.height = newHeight + 'px';
                
                // Обновляем размер карты Leaflet
                if (map) {
                    map.invalidateSize();
                }
            }
        }
        
        // Функция для уменьшения высоты карты
        function decreaseMapHeight() {
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                // Получаем текущую высоту из style или используем высоту по умолчанию
                const currentStyleHeight = mapContainer.style.height;
                let currentHeight = 600; // значение по умолчанию
                
                if (currentStyleHeight && currentStyleHeight.endsWith('px')) {
                    currentHeight = parseInt(currentStyleHeight);
                } else {
                    // Если высота задана через CSS, получаем computed style
                    const computedHeight = window.getComputedStyle(mapContainer).height;
                    if (computedHeight.endsWith('px')) {
                        currentHeight = parseInt(computedHeight);
                    }
                }
                
                const newHeight = Math.max(currentHeight - 200, 400); // Не менее 400px
                mapContainer.style.height = newHeight + 'px';
                
                // Обновляем размер карты Leaflet
                if (map) {
                    map.invalidateSize();
                }
            }
        }
        
        function updateMap() {
            if (!map) {
                console.error('Карта не инициализирована');
                return;
            }
            
            // Очищаем старые маркеры
            mapMarkers.forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            mapMarkers = [];
            
            // Убираем выделенные маркеры
            selectedBSMarkers.forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            selectedBSMarkers = [];
            
            const selectedRegions = getMultiselectValues('mapRegionFilter');
            const selectedCenters = getMultiselectValues('mapCenterFilter');
            const selectedSeverity = getMultiselectValues('mapSeverityFilter');
            const selectedStatus = getMultiselectValues('mapStatusFilter');
            const displayType = document.getElementById('mapDisplayType').value;
            
            // Получаем БС на батарейках
            const batteryBSList = getBatteryBS();
            const batteryBSSet = new Set(batteryBSList.map(bs => bs.bbuName));
            
            let workingCount = 0;
            let batteryCount = 0;
            let notWorkingCount = 0;
            let disconnectedCount = 0;
            let noMPFCount = 0;
            let analysisCount = 0;
            
            // Массив для хранения маркеров для центрирования
            const markersForBounds = [];
            
            // В зависимости от режима отображения выбираем данные
            if (mapDisplayMode === 'monitoring' || displayType === 'monitoring') {
                // Режим мониторинга
                const disconnectedBS = getDisconnectedBS();
                const batteryBS = getBatteryBS();
                const workingBS = getWorkingBS();
                
                // Фильтруем данные по выбранным фильтрам
                let filteredDisconnected = disconnectedBS;
                let filteredBattery = batteryBS;
                let filteredWorking = workingBS;
                
                if (selectedRegions.length > 0) {
                    filteredDisconnected = filteredDisconnected.filter(bs => selectedRegions.includes(bs.region));
                    filteredBattery = filteredBattery.filter(bs => selectedRegions.includes(bs.region));
                    filteredWorking = filteredWorking.filter(bs => selectedRegions.includes(bs.region));
                }
                
                if (selectedCenters.length > 0) {
                    filteredDisconnected = filteredDisconnected.filter(bs => selectedCenters.includes(bs.center));
                    filteredBattery = filteredBattery.filter(bs => selectedCenters.includes(bs.center));
                    filteredWorking = filteredWorking.filter(bs => selectedCenters.includes(bs.center));
                }
                
                // Объединяем все БС (исключаем no-mpf)
                const allFilteredBS = [
                    ...filteredDisconnected,
                    ...filteredBattery,
                    ...filteredWorking
                ];
                
                // Добавляем маркеры для каждой БС
                allFilteredBS.forEach(bs => {
                    const info = bbuInfoMap[bs.bbuName];
                    if (!info || info.latitude === undefined || info.longitude === undefined ||
                        isNaN(info.latitude) || isNaN(info.longitude)) {
                        console.warn(`Пропускаем БС ${bs.bbuName} - нет координат`);
                        return;
                    }
                    
                    // Выбираем цвет в зависимости от типа
                    let color;
                    switch(bs.type) {
                        case 'disconnected':
                            color = monitoringColors.disconnected; // Красный
                            disconnectedCount++;
                            break;
                        case 'battery':
                            color = monitoringColors.battery; // Оранжевый
                            batteryCount++;
                            break;
                        case 'working':
                            color = monitoringColors.working; // Зеленый
                            workingCount++;
                            break;
                        default:
                            color = '#757575'; // Серый
                    }
                    
                    // Создаем маркер
                    const marker = createMonitoringMarker(info, bs, color);
                    if (marker) {
                        mapMarkers.push(marker);
                        markersForBounds.push(marker);
                    }
                });
                
                mapDisplayMode = 'monitoring';
                
            } else if (mapDisplayMode === 'analysis' || displayType === 'analysis') {
                // Режим анализа аварий
                // Фильтруем аварии по выбранным фильтрам
                let filteredAlarmsForMap = allAlarms.filter(alarm => {
                    // Фильтр по региону
                    if (selectedRegions.length > 0) {
                        const region = getRegionFromBBU(alarm.bbuName);
                        if (!region || !selectedRegions.includes(region)) return false;
                    }
                    
                    // Фильтр по центру
                    if (selectedCenters.length > 0) {
                        const center = getExploitationCenter(alarm.bbuName);
                        if (!center || !selectedCenters.includes(center)) return false;
                    }
                    
                    // Фильтр по критичности
                    if (selectedSeverity.length > 0) {
                        if (!selectedSeverity.includes(alarm.severity)) return false;
                    }
                    
                    // Фильтр по статусу
                    if (selectedStatus.length > 0) {
                        if (selectedStatus.includes('uncleared') && !isUnclearedAlarm(alarm)) return false;
                        if (selectedStatus.includes('cleared') && isUnclearedAlarm(alarm)) return false;
                    }
                    
                    // Фильтр по категориям аварий (новое изменение)
                    const selectedCategories = getMultiselectValues('mapCategoryFilter');
                    if (selectedCategories.length > 0) {
                        const category = alarm.category || 'other';
                        if (!selectedCategories.includes(category)) return false;
                    }
                    
                    return true;
                });
                
                // Группируем аварии по БС
                const alarmsByBS = {};
                filteredAlarmsForMap.forEach(alarm => {
                    if (!alarmsByBS[alarm.bbuName]) {
                        alarmsByBS[alarm.bbuName] = [];
                    }
                    alarmsByBS[alarm.bbuName].push(alarm);
                });
                
                // Добавляем маркеры для каждой БС с авариями
                Object.keys(alarmsByBS).forEach(bbuName => {
                    const info = bbuInfoMap[bbuName];
                    if (!info || info.latitude === undefined || info.longitude === undefined ||
                        isNaN(info.latitude) || isNaN(info.longitude)) {
                        return;
                    }
                    
                    const bsAlarms = alarmsByBS[bbuName];
                    
                    // Определяем самый высокий уровень критичности
                    let highestSeverity = 'Warning';
                    const severityOrder = { 'Critical': 4, 'Major': 3, 'Minor': 2, 'Warning': 1 };
                    
                    bsAlarms.forEach(alarm => {
                        if (severityOrder[alarm.severity] > severityOrder[highestSeverity]) {
                            highestSeverity = alarm.severity;
                        }
                    });
                    
                    // Выбираем цвет по критичности
                    const color = severityColors[highestSeverity] || severityColors.Warning;
                    
                    // Создаем маркер
                    const marker = createAnalysisMarker(info, bsAlarms, highestSeverity, color);
                    if (marker) {
                        mapMarkers.push(marker);
                        markersForBounds.push(marker);
                        analysisCount++;
                    }
                });
                
                mapDisplayMode = 'analysis';
                
            } else {
                // Режим "все БС"
                // Добавляем маркеры для всех БС
                Object.entries(bbuInfoMap).forEach(([bbuName, info]) => {
                    if (info.latitude === undefined || info.longitude === undefined ||
                        isNaN(info.latitude) || isNaN(info.longitude)) {
                        return;
                    }
                    
                    // Проверяем операционный статус
                    if (!info.operationalStatus) return;
                    const status = info.operationalStatus.toString().trim();
                    if (!VALID_OPERATIONAL_STATUSES.some(validStatus => status.includes(validStatus))) {
                        return; // Пропускаем БС с недопустимым статусом
                    }
                    
                    // Проверяем фильтр по региону
                    const region = getRegionFromBBU(bbuName);
                    if (selectedRegions.length > 0 && !selectedRegions.includes(region)) {
                        return;
                    }
                    
                    // Проверяем фильтр по центру
                    const center = info.center;
                    if (selectedCenters.length > 0 && !selectedCenters.includes(center)) {
                        return;
                    }
                    
                    // Проверяем фильтр по наличию аварий
                    const bsAlarms = allAlarms.filter(alarm => alarm.bbuName === bbuName);
                    const hasAlarms = bsAlarms.length > 0;
                    
                    if (displayType === 'with_alarms' && !hasAlarms) {
                        return;
                    }
                    if (displayType === 'without_alarms' && hasAlarms) {
                        return;
                    }
                    
                    // Проверяем фильтры по критичности и статусу, если есть аварии
                    if (hasAlarms && (selectedSeverity.length > 0 || selectedStatus.length > 0)) {
                        const filteredBSAlarms = bsAlarms.filter(alarm => {
                            if (selectedSeverity.length > 0 && !selectedSeverity.includes(alarm.severity)) {
                                return false;
                            }
                            if (selectedStatus.length > 0) {
                                const isUncleared = isUnclearedAlarm(alarm);
                                if (selectedStatus.includes('uncleared') && !isUncleared) return false;
                                if (selectedStatus.includes('cleared') && isUncleared) return false;
                            }
                            return true;
                        });
                        
                        if (filteredBSAlarms.length === 0) {
                            return;
                        }
                    }
                    
                    // Определяем статус БС
                    const isOnBattery = batteryBSSet.has(bbuName);
                    const bsStatus = getBSStatusDetailed(bbuName);
                    const isWorking = bsStatus === 'working';
                    
                    // Подсчитываем статистику
                    if (isOnBattery) batteryCount++;
                    else if (isWorking) workingCount++;
                    else notWorkingCount++;
                    
                    // Выбираем цвет маркера
                    let color;
                    if (isOnBattery) {
                        color = '#ff9800'; // Оранжевый для БС на батарейках
                    } else if (isWorking) {
                        color = '#4caf50'; // Зеленый для работающих
                    } else {
                        color = '#f44336'; // Красный для неработающих
                    }
                    
                    // Создаем маркер
                    const marker = createDefaultMarker(info, bsAlarms, color, hasAlarms);
                    if (marker) {
                        mapMarkers.push(marker);
                        markersForBounds.push(marker);
                    }
                });
                
                mapDisplayMode = 'all';
            }
            
            // Обновляем статистику карты (убрали noMPF из отображения)
            updateMapStats(workingCount, batteryCount, notWorkingCount, disconnectedCount, 0, analysisCount);
            
            // Если есть маркеры, центрируем карту на них
            if (markersForBounds.length > 0) {
                const group = L.featureGroup(markersForBounds);
                const bounds = group.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds.pad(0.1));
                }
            } else {
                // Если нет маркеров, центрируем на Украине
                map.setView([49.0, 31.0], 6);
            }
            
            // Обновляем размеры карты после добавления маркеров
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        }
        
        // Создание маркера для мониторинга
        function createMonitoringMarker(info, bsData, color) {
            const alarmCount = bsData.type === 'working' ? 0 : 1;
            const markerSize = 20 + Math.min(alarmCount, 5) * 2;
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="background-color: ${color}; width: ${markerSize}px; 
                          height: ${markerSize}px; border-radius: 50%; 
                          border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                          display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${alarmCount > 0 ? alarmCount : ''}
                    </div>
                `,
                iconSize: [markerSize, markerSize],
                iconAnchor: [markerSize / 2, markerSize / 2],
                popupAnchor: [0, -markerSize / 2]
            });
            
            // Создаем всплывающую подсказку
            const popupContent = createMonitoringPopupContent(info, bsData);
            
            // Создаем маркер
            const marker = L.marker([info.latitude, info.longitude], { icon })
                .bindPopup(popupContent, {
                    maxWidth: 400,
                    className: 'custom-popup'
                });
            
            marker.addTo(map);
            return marker;
        }
        
        // Создание маркера для анализа аварий
        function createAnalysisMarker(info, bsAlarms, highestSeverity, color) {
            const alarmCount = bsAlarms.length;
            const markerSize = 20 + Math.min(alarmCount, 5) * 2;
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="background-color: ${color}; width: ${markerSize}px; 
                          height: ${markerSize}px; border-radius: 50%; 
                          border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                          display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${alarmCount > 0 ? alarmCount : ''}
                    </div>
                `,
                iconSize: [markerSize, markerSize],
                iconAnchor: [markerSize / 2, markerSize / 2],
                popupAnchor: [0, -markerSize / 2]
            });
            
            // Создаем всплывающую подсказку
            const popupContent = createAnalysisPopupContent(info, bsAlarms, highestSeverity);
            
            // Создаем маркер
            const marker = L.marker([info.latitude, info.longitude], { icon })
                .bindPopup(popupContent, {
                    maxWidth: 400,
                    className: 'custom-popup'
                });
            
            marker.addTo(map);
            return marker;
        }
        
        // Создание стандартного маркера
        function createDefaultMarker(info, bsAlarms, color, hasAlarms) {
            const alarmCount = bsAlarms.length;
            const markerSize = 20 + Math.min(alarmCount, 5) * 2;
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="background-color: ${color}; width: ${markerSize}px; 
                          height: ${markerSize}px; border-radius: 50%; 
                          border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                          display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        ${alarmCount > 0 ? alarmCount : ''}
                    </div>
                `,
                iconSize: [markerSize, markerSize],
                iconAnchor: [markerSize / 2, markerSize / 2],
                popupAnchor: [0, -markerSize / 2]
            });
            
            // Создаем всплывающую подсказку
            const activeAlarms = bsAlarms.filter(alarm => isUnclearedAlarm(alarm));
            const popupContent = createMapPopupContent(info.bbuName, info, activeAlarms);
            
            // Создаем маркер
            const marker = L.marker([info.latitude, info.longitude], { icon })
                .bindPopup(popupContent, {
                    maxWidth: 400,
                    className: 'custom-popup'
                });
            
            marker.addTo(map);
            return marker;
        }
        
        // Создание контента для popup мониторинга
        function createMonitoringPopupContent(info, bsData) {
            const region = getRegionFromBBU(info.bbuName);
            const center = info.center;
            const category = info.category;
            const address = info.address;
            const bsType = info.bsType;
            const transportType = info.transportType;
            const batteryCapacity = info.batteryCapacity || 180;
            const operationalStatus = info.operationalStatus;
            
            let statusText = '';
            let statusColor = '';
            
            switch(bsData.type) {
                case 'disconnected':
                    statusText = 'Лежащая БС';
                    statusColor = '#c62828';
                    break;
                case 'battery':
                    statusText = 'БС на батарейках';
                    statusColor = '#ff9800';
                    break;
                case 'no-mpf':
                    statusText = 'БС без MPF';
                    statusColor = '#3949ab';
                    break;
                case 'working':
                    statusText = 'БС в работе';
                    statusColor = '#4caf50';
                    break;
                default:
                    statusText = 'Статус не определен';
                    statusColor = '#757575';
            }
            
            let popupHTML = `
                <div style="max-width: 400px; font-family: Arial, sans-serif;">
                    <h4 style="margin: 0 0 10px 0; color: ${statusColor}; border-bottom: 2px solid ${statusColor}; padding-bottom: 5px;">${escapeHtml(info.bbuName)}</h4>
                    <div style="background-color: ${statusColor}20; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <strong style="color: ${statusColor};">${statusText}</strong>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold; width: 40%;">Регион:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(region || 'Не определен')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">ЦЭ:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(center || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Адрес:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(address || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">KAT TS:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(category || 'Не указана')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Признак:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(bsType || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Трансмиссия:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(transportType || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Емкость АКБ:</td>
                            <td style="padding: 4px 8px;">${batteryCapacity} мин</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Статус:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(operationalStatus || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Координаты:</td>
                            <td style="padding: 4px 8px;">${info.latitude.toFixed(6)}, ${info.longitude.toFixed(6)}</td>
                        </tr>
            `;
            
            // Добавляем дополнительную информацию в зависимости от типа
            if (bsData.type === 'disconnected' && bsData.durationFormatted) {
                popupHTML += `
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Длительность:</td>
                            <td style="padding: 4px 8px;">${bsData.durationFormatted}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Время возникновения:</td>
                            <td style="padding: 4px 8px;">${formatDateTime(bsData.occurred)}</td>
                        </tr>
                `;
            } else if (bsData.type === 'battery' && bsData.remainingFormatted) {
                popupHTML += `
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Остаток АКБ:</td>
                            <td style="padding: 4px 8px;">${bsData.remainingFormatted}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Использовано АКБ:</td>
                            <td style="padding: 4px 8px;">${bsData.batteryDurationFormatted}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Уровень АКБ:</td>
                            <td style="padding: 4px 8px;">${bsData.percentage.toFixed(1)}%</td>
                        </tr>
                `;
            } else if (bsData.type === 'no-mpf' && bsData.durationFormatted) {
                popupHTML += `
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Длительность:</td>
                            <td style="padding: 4px 8px;">${bsData.durationFormatted}</td>
                        </tr>
                `;
            }
            
            popupHTML += `
                    </table>
                </div>
            `;
            
            return popupHTML;
        }
        
        // Создание контента для popup анализа аварий
        function createAnalysisPopupContent(info, bsAlarms, highestSeverity) {
            const region = getRegionFromBBU(info.bbuName);
            const center = info.center;
            const category = info.category;
            const address = info.address;
            const bsType = info.bsType;
            const transportType = info.transportType;
            const batteryCapacity = info.batteryCapacity || 180;
            const operationalStatus = info.operationalStatus;
            
            const severityColor = severityColors[highestSeverity] || severityColors.Warning;
            
            let popupHTML = `
                <div style="max-width: 400px; font-family: Arial, sans-serif;">
                    <h4 style="margin: 0 0 10px 0; color: ${severityColor}; border-bottom: 2px solid ${severityColor}; padding-bottom: 5px;">${escapeHtml(info.bbuName)}</h4>
                    <div style="background-color: ${severityColor}20; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <strong style="color: ${severityColor};">Наибольшая критичность: ${escapeHtml(highestSeverity)}</strong>
                        <div>Всего аварий: ${bsAlarms.length}</div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold; width: 40%;">Регион:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(region || 'Не определен')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">ЦЭ:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(center || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Адрес:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(address || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">KAT TS:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(category || 'Не указана')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Признак:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(bsType || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Трансмиссия:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(transportType || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Емкость АКБ:</td>
                            <td style="padding: 4px 8px;">${batteryCapacity} мин</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Статус:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(operationalStatus || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Координаты:</td>
                            <td style="padding: 4px 8px;">${info.latitude.toFixed(6)}, ${info.longitude.toFixed(6)}</td>
                        </tr>
                    </table>
            `;
            
            // Добавляем список аварий
            if (bsAlarms.length > 0) {
                const activeAlarms = bsAlarms.filter(alarm => isUnclearedAlarm(alarm));
                
                popupHTML += `
                    <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                        <h5 style="margin: 0 0 8px 0; color: ${severityColor};">Аварии (${bsAlarms.length}, активных: ${activeAlarms.length}):</h5>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%; font-size: 12px; border-collapse: collapse; border: 1px solid #ddd;">
                                <thead>
                                    <tr style="background-color: #f2f2f2;">
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">ID</th>
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Название</th>
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Крит.</th>
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Статус</th>
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Время</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                bsAlarms.forEach(alarm => {
                    const isActive = isUnclearedAlarm(alarm);
                    const statusColor = isActive ? '#c62828' : '#2e7d32';
                    
                    popupHTML += `
                        <tr>
                            <td style="padding: 4px; border: 1px solid #ddd;">${escapeHtml(alarm.alarmId)}</td>
                            <td style="padding: 4px; border: 1px solid #ddd;">${escapeHtml(alarm.alarmName.substring(0, 30))}${alarm.alarmName.length > 30 ? '...' : ''}</td>
                            <td style="padding: 4px; border: 1px solid #ddd;">${escapeHtml(alarm.severity)}</td>
                            <td style="padding: 4px; border: 1px solid #ddd; color: ${statusColor};">${isActive ? 'Активна' : 'Устранена'}</td>
                            <td style="padding: 4px; border: 1px solid #ddd;">${formatDateTime(alarm.firstOccurred)}</td>
                        </tr>
                    `;
                });
                
                popupHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            popupHTML += `</div>`;
            return popupHTML;
        }
        
        // Создание контента для popup на карте
        function createMapPopupContent(bbuName, info, activeAlarms) {
            const region = getRegionFromBBU(bbuName);
            const center = info.center;
            const category = info.category;
            const address = info.address;
            const bsType = info.bsType;
            const transportType = info.transportType;
            const batteryCapacity = info.batteryCapacity || 180;
            const operationalStatus = info.operationalStatus;
            
            // Определяем статус БС
            const bsStatus = getBSStatusDetailed(bbuName);
            const statusText = bsStatus === 'battery' ? 'БС на батарейках' : 
                             bsStatus === 'not_working' ? 'БС не работает' : 'БС работает';
            
            let popupHTML = `
                <div style="max-width: 400px; font-family: Arial, sans-serif;">
                    <h4 style="margin: 0 0 10px 0; color: #1a237e; border-bottom: 2px solid #1a237e; padding-bottom: 5px;">${escapeHtml(bbuName)}</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold; width: 40%;">Состояние:</td>
                            <td style="padding: 4px 8px;">${statusText}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Регион:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(region || 'Не определен')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">ЦЭ:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(center || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Адрес:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(address || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">KAT TS:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(category || 'Не указана')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Признак:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(bsType || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Трансмиссия:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(transportType || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Емкость АКБ:</td>
                            <td style="padding: 4px 8px;">${batteryCapacity} мин</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Статус:</td>
                            <td style="padding: 4px 8px;">${escapeHtml(operationalStatus || 'Не указан')}</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 8px; font-weight: bold;">Координаты:</td>
                            <td style="padding: 4px 8px;">${info.latitude.toFixed(6)}, ${info.longitude.toFixed(6)}</td>
                        </tr>
                    </table>
            `;
            
            if (activeAlarms.length > 0) {
                popupHTML += `
                    <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                        <h5 style="margin: 0 0 8px 0; color: #c62828;">Активные аварии (${activeAlarms.length}):</h5>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table style="width: 100%; font-size: 12px; border-collapse: collapse; border: 1px solid #ddd;">
                                <thead>
                                    <tr style="background-color: #f2f2f2;">
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">ID</th>
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Название</th>
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Крит.</th>
                                        <th style="padding: 4px; border: 1px solid #ddd; text-align: left;">Время</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                activeAlarms.forEach(alarm => {
                    popupHTML += `
                        <tr>
                            <td style="padding: 4px; border: 1px solid #ddd;">${escapeHtml(alarm.alarmId)}</td>
                            <td style="padding: 4px; border: 1px solid #ddd;">${escapeHtml(alarm.alarmName.substring(0, 30))}${alarm.alarmName.length > 30 ? '...' : ''}</td>
                            <td style="padding: 4px; border: 1px solid #ddd;">${escapeHtml(alarm.severity)}</td>
                            <td style="padding: 4px; border: 1px solid #ddd;">${formatDateTime(alarm.firstOccurred)}</td>
                        </tr>
                    `;
                });
                
                popupHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                popupHTML += `
                    <div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">
                        <p style="margin: 0; color: #666;"><strong>Активные аварии:</strong> нет</p>
                    </div>
                `;
            }
            
            popupHTML += `</div>`;
            return popupHTML;
        }
        
        // Поиск БС на карте
        function searchBSOnMap() {
            const searchTerm = document.getElementById('mapSearch').value.toLowerCase();
            const resultsContainer = document.getElementById('mapSearchResults');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Фильтруем БС по имени
            mapSearchResultsList = Object.keys(bbuInfoMap).filter(bbuName => 
                bbuName.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Ограничиваем 10 результатами
            
            if (mapSearchResultsList.length === 0) {
                resultsContainer.innerHTML = '<div class="map-search-result-item">Нет результатов</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            // Отображаем результаты
            resultsContainer.innerHTML = '';
            mapSearchResultsList.forEach(bbuName => {
                const resultItem = document.createElement('div');
                resultItem.className = 'map-search-result-item';
                resultItem.textContent = bbuName;
                resultItem.onclick = function() {
                    focusOnBSOnMap(bbuName);
                    resultsContainer.style.display = 'none';
                    document.getElementById('mapSearch').value = bbuName;
                };
                resultsContainer.appendChild(resultItem);
            });
            
            resultsContainer.style.display = 'block';
        }
        
        // Фокусировка на БС на карте
        function focusOnBSOnMap(bbuName) {
            const info = bbuInfoMap[bbuName];
            if (!info || info.latitude === undefined || info.longitude === undefined || 
                isNaN(info.latitude) || isNaN(info.longitude)) {
                showMessage('Координаты БС не найдены', 'warning');
                return;
            }
            
            // Перемещаем карту к БС
            map.setView([info.latitude, info.longitude], 15);
            
            // Выделяем маркер
            mapMarkers.forEach(marker => {
                const markerLatLng = marker.getLatLng();
                if (markerLatLng.lat === info.latitude && markerLatLng.lng === info.longitude) {
                    marker.openPopup();
                    
                    // Анимируем выделение
                    const originalIcon = marker.options.icon;
                    const highlightIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `
                            <div style="background-color: #1a237e; width: 30px; height: 30px; border-radius: 50%; 
                                  border: 3px solid white; box-shadow: 0 0 10px #1a237e;
                                  display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                <i class="fas fa-crosshairs"></i>
                            </div>
                        `,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15],
                        popupAnchor: [0, -15]
                    });
                    
                    marker.setIcon(highlightIcon);
                    
                    // Через 3 секунды возвращаем оригинальную иконку
                    setTimeout(() => {
                        marker.setIcon(originalIcon);
                    }, 3000);
                }
            });
        }
        
        // Очистить выделение на карте
        function clearMapSelection() {
            selectedBSMarkers.forEach(marker => {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            selectedBSMarkers = [];
            showMessage('Выделение на карте очищено', 'info');
        }
        
        function updateMapStats(working, battery, notWorking, disconnected = 0, noMPF = 0, analysis = 0) {
            const mapStats = document.getElementById('mapStats');
            if (!mapStats) return;
            
            let statsHTML = '';
            
            if (mapDisplayMode === 'monitoring') {
                statsHTML = `
                    <div class="monitoring-stat-card" style="border-top-color: #4caf50;">
                        <div class="stat-card-title">
                            <i class="fas fa-check-circle"></i> БС в работе
                        </div>
                        <div class="stat-card-value" style="color: #4caf50;">${working}</div>
                    </div>
                    <div class="monitoring-stat-card" style="border-top-color: #f44336;">
                        <div class="stat-card-title">
                            <i class="fas fa-power-off"></i> Лежащие БС
                        </div>
                        <div class="stat-card-value" style="color: #f44336;">${disconnected}</div>
                    </div>
                    <div class="monitoring-stat-card" style="border-top-color: #ff9800;">
                        <div class="stat-card-title">
                            <i class="fas fa-car-battery"></i> БС на батарейках
                        </div>
                        <div class="stat-card-value" style="color: #ff9800;">${battery}</div>
                    </div>
                `;
            } else if (mapDisplayMode === 'analysis') {
                statsHTML = `
                    <div class="monitoring-stat-card" style="border-top-color: #1a237e;">
                        <div class="stat-card-title">
                            <i class="fas fa-exclamation-circle"></i> БС с авариями
                        </div>
                        <div class="stat-card-value" style="color: #1a237e;">${analysis}</div>
                    </div>
                `;
            } else {
                statsHTML = `
                    <div class="monitoring-stat-card" style="border-top-color: #4caf50;">
                        <div class="stat-card-title">
                            <i class="fas fa-check-circle"></i> БС в работе
                        </div>
                        <div class="stat-card-value" style="color: #4caf50;">${working}</div>
                    </div>
                    <div class="monitoring-stat-card" style="border-top-color: #ff9800;">
                        <div class="stat-card-title">
                            <i class="fas fa-car-battery"></i> БС на батарейках
                        </div>
                        <div class="stat-card-value" style="color: #ff9800;">${battery}</div>
                    </div>
                    <div class="monitoring-stat-card" style="border-top-color: #f44336;">
                        <div class="stat-card-title">
                            <i class="fas fa-times-circle"></i> БС не работает
                        </div>
                        <div class="stat-card-value" style="color: #f44336;">${notWorking}</div>
                    </div>
                    <div class="monitoring-stat-card" style="border-top-color: #1a237e;">
                        <div class="stat-card-title">
                            <i class="fas fa-map-marker-alt"></i> Всего на карте
                        </div>
                        <div class="stat-card-value" style="color: #1a237e;">${working + battery + notWorking}</div>
                    </div>
                `;
            }
            
            mapStats.innerHTML = statsHTML;
        }
        
        // ===================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ =====================
        
        // Получение региона по BBU Name
        function getRegionFromBBU(bbuName) {
            if (!bbuName) return 'Не определен';
            
            const prefix = bbuName.substring(0, 3).toUpperCase();
            return regionMapping[prefix] ? regionMapping[prefix].name : 'Не определен';
        }
        
        // Получение региона из источника
        function getRegionFromSource(alarmSource) {
            if (!alarmSource) return null;
            
            const upperSource = alarmSource.toUpperCase();
            for (const prefix in regionMapping) {
                if (upperSource.startsWith(prefix)) {
                    return regionMapping[prefix].name;
                }
            }
            return null;
        }
        
        // Получение региона из подсети
        function getRegionFromSubnet(subnet) {
            if (!subnet) return null;
            
            const upperSubnet = subnet.toUpperCase();
            if (upperSubnet.includes('/SIM_') || upperSubnet.includes('SIMFEROPOL')) return 'Крым';
            if (upperSubnet.includes('/DON_') || upperSubnet.includes('DONETSK')) return 'ДНР';
            if (upperSubnet.includes('/LUG_') || upperSubnet.includes('LUGANSK')) return 'ЛНР';
            if (upperSubnet.includes('/ARM_') || upperSubnet.includes('ARM_')) return 'ХО';
            if (upperSubnet.includes('/DZH_') || upperSubnet.includes('DZH_')) return 'ЗО';
            
            return null;
        }
        
        // Получение центра эксплуатации
        function getExploitationCenter(bbuName) {
            return bbuInfoMap[bbuName]?.center || 'Не указан';
        }
        
        // Получение категории БС
        function getCategory(bbuName) {
            return bbuInfoMap[bbuName]?.category || 'Не указана';
        }
        
        // Получение адреса БС
        function getAddress(bbuName) {
            return bbuInfoMap[bbuName]?.address || '';
        }
        
        // Получение детального статуса БС (работает/не работает/на батарейках)
        function getBSStatusDetailed(bbuName) {
            // Проверяем, находится ли БС на батарейках
            const isOnBattery = cycles.some(cycle => 
                cycle.bbuName === bbuName && 
                cycle.endType === 'Unfinished'
            );
            
            if (isOnBattery) {
                return 'battery';
            }
            
            // Проверяем, есть ли активная авария "NE Is Disconnected"
            const hasActiveNID = allAlarms.some(alarm => 
                alarm.bbuName === bbuName && 
                alarm.alarmName && 
                alarm.alarmName.includes('NE Is Disconnected') && 
                isUnclearedAlarm(alarm)
            );
            
            if (hasActiveNID) {
                return 'not_working';
            }
            
            return 'working';
        }
        
        // Проверка, является ли авария активной (Uncleared)
        function isUnclearedAlarm(alarm) {
            if (alarm.clearanceStatus !== undefined && alarm.clearanceStatus !== null) {
                const status = alarm.clearanceStatus.toString().toLowerCase();
                return status.includes('uncleared') || status.includes('active') ||
                       status === '' || status === '-' || status === 'null' || status === 'n/a' ||
                       status === 'не устранено' || status === 'неустранено';
            }
            
            // Если статус очистки не указан, проверяем clearedOn
            if (alarm.clearedOn) {
                const clearedDate = parseDate(alarm.clearedOn);
                return !clearedDate; // Если дата очистки не парсится, считаем аварию активной
            }
            
            return true; // По умолчанию считаем аварию активной
        }
        
        // Получение цвета для критичности
        function getSeverityColor(severity) {
            return severityColors[severity] || '#757575';
        }
        
        // Форматирование даты и времени
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return 'N/A';
            
            const date = parseDate(dateTimeStr);
            if (!date) return 'Неверный формат';
            
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Форматирование даты
        function formatDate(dateString) {
            if (!dateString || dateString === '-' || dateString === '') return 'Нет данных';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                return date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        // Обновление статистики в шапке
        function updateHeaderStats() {
            const totalAlarms = allAlarms.length;
            const unclearedAlarms = allAlarms.filter(alarm => isUnclearedAlarm(alarm)).length;
            const affectedBS = new Set(allAlarms.map(alarm => alarm.bbuName)).size;
            const criticalAlarms = allAlarms.filter(alarm => alarm.severity === 'Critical').length;
            
            document.getElementById('totalAlarmsStat').textContent = totalAlarms;
            document.getElementById('unclearedAlarmsStat').textContent = unclearedAlarms;
            document.getElementById('affectedBSStat').textContent = affectedBS;
            document.getElementById('criticalAlarmsStat').textContent = criticalAlarms;
        }
        
        // Показать/скрыть лоадер
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }
        
        // Показать сообщение
        function showMessage(message, type) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            if (type !== 'info') {
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Открытие вкладки
        function openTab(tabId) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Показываем выбранную вкладку
            document.getElementById(tabId).classList.add('active');
            
            // Активируем кнопку
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // При открытии вкладки многоповторок обновляем таблицу
            if (tabId === 'detailedAnalytics') {
                const activeAnalyticsTab = document.querySelector('.analytics-tab.active');
                if (activeAnalyticsTab && activeAnalyticsTab.getAttribute('data-analytics-tab') === 'repeats') {
                    displayRepeatsTable();
                }
            }
            
            // При открытии вкладки карты обновляем размеры карты
            if (tabId === 'map' && map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }
        
        // Переключение списка БС
        function toggleBSList(header) {
            const bsList = header.nextElementSibling;
            bsList.classList.toggle('expanded');
        }
        
        // Переключение контейнера категории
        function toggleCategoryContainer(header) {
            const container = header.nextElementSibling;
            container.classList.toggle('expanded');
        }
        
        // Переключение контейнера аварий
        function toggleAlarmsContainer(header) {
            const container = header.nextElementSibling;
            container.classList.toggle('expanded');
        }
        
        // Открытие вкладки детальной аналитики
        function openAnalyticsTab(tabId) {
            // Скрываем все вкладки
            document.querySelectorAll('.analytics-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Убираем активный класс со всех кнопок
            document.querySelectorAll('.analytics-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Показываем выбранную вкладку
            document.getElementById(tabId).classList.add('active');
            
            // Активируем кнопку
            document.querySelector(`[data-analytics-tab="${tabId}"]`).classList.add('active');
            
            // Загружаем данные для вкладки
            switch(tabId) {
                case 'repeats':
                    displayRepeatsTable();
                    break;
                case 'cycles':
                    displayCyclesTable();
                    break;
                case 'statistics':
                    displayBBUStatisticsTable();
                    break;
                case 'disconnected':
                    displayDisconnectedTable();
                    break;
                case 'bsinfo':
                    displayBSInfoTable();
                    break;
            }
        }
        
        // ===================== КОНСТРУКТОР КАТЕГОРИЙ =====================
        
        // Открытие конструктора категорий
        function openConstructor() {
            if (allAlarms.length === 0) {
                showMessage('Сначала загрузите файл аварий', 'error');
                return;
            }
            
            const modal = document.getElementById('constructorModal');
            modal.style.display = 'block';
            
            // Заполняем конструктор
            renderConstructor();
            
            // Инициализируем drag and drop
            initDragAndDrop();
        }
        
        // Закрытие конструктора
        function closeConstructor() {
            const modal = document.getElementById('constructorModal');
            modal.style.display = 'none';
        }
        
        // Сохранение категорий и закрытие конструктора
        function saveCategoriesAndClose() {
            saveSettings();
            showMessage('Настройки категорий сохранены', 'success');
            
            // Обновляем отображение с новыми категориями
            updateAlarmAnalysis();
            closeConstructor();
        }
        
        // Рендеринг конструктора
        function renderConstructor() {
            const constructorGrid = document.getElementById('constructorGrid');
            
            // Группируем уникальные аварии
            const uniqueAlarms = getUniqueAlarmsForConstructor();
            
            // Группируем аварии по текущим категориям
            const alarmsByCategory = {};
            uniqueAlarms.forEach(alarm => {
                const category = alarm.category || 'other';
                const subcategory = alarm.subcategory || 'other';
                
                if (!alarmsByCategory[category]) {
                    alarmsByCategory[category] = {};
                }
                
                if (!alarmsByCategory[category][subcategory]) {
                    alarmsByCategory[category][subcategory] = [];
                }
                
                alarmsByCategory[category][subcategory].push(alarm);
            });
            
            // Создаем категории в конструкторе
            let constructorHTML = '';
            
            Object.keys(defaultAlarmCategories).forEach(categoryKey => {
                const category = defaultAlarmCategories[categoryKey];
                const subcategoryAlarms = alarmsByCategory[categoryKey] || {};
                
                // Собираем все аварии из всех подкатегорий
                let allAlarms = [];
                Object.values(subcategoryAlarms).forEach(alarms => {
                    allAlarms = allAlarms.concat(alarms);
                });
                
                // Сортируем по ID
                const sortedAlarms = allAlarms.sort((a, b) => a.id.localeCompare(b.id));
                
                constructorHTML += `
                    <div class="constructor-category" data-category="${categoryKey}">
                        <h4>
                            <i class="${category.icon}"></i>
                            ${category.name}
                        </h4>
                        <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                            ${category.description}
                        </p>
                        <div class="constructor-alarm-list" id="category-${categoryKey}">
                            ${sortedAlarms.map(alarm => `
                                <div class="constructor-alarm-item" draggable="true" 
                                     data-alarm-id="${escapeHtml(alarm.id)}" data-category="${categoryKey}">
                                    <span class="alarm-id">${escapeHtml(alarm.id)}</span>
                                    <span class="alarm-name-small" title="${escapeHtml(alarm.name)}">
                                        ${escapeHtml(alarm.name)}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            constructorGrid.innerHTML = constructorHTML;
        }
        
        // Получение уникальных аварий для конструктора
        function getUniqueAlarmsForConstructor() {
            const uniqueAlarmsMap = new Map();
            
            allAlarms.forEach(alarm => {
                if (!uniqueAlarmsMap.has(alarm.alarmId)) {
                    uniqueAlarmsMap.set(alarm.alarmId, {
                        id: alarm.alarmId,
                        name: alarm.alarmName, // Используем оригинальное название
                        category: alarm.category,
                        subcategory: alarm.subcategory
                    });
                }
            });
            
            return Array.from(uniqueAlarmsMap.values());
        }
        
        // Инициализация drag and drop
        function initDragAndDrop() {
            let draggedItem = null;
            let draggedFromCategory = null;
            
            // Обработчики для перетаскиваемых элементов
            document.querySelectorAll('.constructor-alarm-item').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    draggedFromCategory = this.dataset.category;
                    this.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', this.dataset.alarmId);
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedItem = null;
                    draggedFromCategory = null;
                });
            });
            
            // Обработчики для категорий
            document.querySelectorAll('.constructor-category').forEach(category => {
                category.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                category.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                
                category.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    
                    if (draggedItem && draggedFromCategory !== this.dataset.category) {
                        const alarmId = draggedItem.dataset.alarmId;
                        const targetCategory = this.dataset.category;
                        const alarmName = draggedItem.querySelector('.alarm-name-small').textContent;
                        
                        // Перемещаем элемент
                        const alarmList = this.querySelector('.constructor-alarm-list');
                        alarmList.appendChild(draggedItem);
                        
                        // Обновляем категорию в данных
                        updateAlarmCategory(alarmId, targetCategory, alarmName);
                        
                        // Сортируем элементы в новой категории
                        sortAlarmsInCategory(this.dataset.category);
                    }
                });
            });
        }
        
        // Сортировка аварий в категории
        function sortAlarmsInCategory(categoryId) {
            const categoryElement = document.querySelector(`[data-category="${categoryId}"]`);
            if (!categoryElement) return;
            
            const alarmList = categoryElement.querySelector('.constructor-alarm-list');
            const alarms = Array.from(alarmList.querySelectorAll('.constructor-alarm-item'));
            
            // Сортируем по ID аварии
            alarms.sort((a, b) => {
                const idA = a.dataset.alarmId;
                const idB = b.dataset.alarmId;
                return idA.localeCompare(idB);
            });
            
            // Переставляем элементы в отсортированном порядке
            alarms.forEach(alarm => {
                alarmList.appendChild(alarm);
            });
        }
        
        // Обновление категории аварии
        function updateAlarmCategory(alarmId, newCategory, alarmName) {
            let newSubcategory = newCategory;
            
            if (newCategory === 'cell_problems') {
                newSubcategory = 'cell_other';
            }
            
            // Обновляем маппинг
            if (alarmTypeMapping[alarmId]) {
                alarmTypeMapping[alarmId].category = newCategory;
                alarmTypeMapping[alarmId].subcategory = newSubcategory;
            } else {
                alarmTypeMapping[alarmId] = {
                    name: alarmName,
                    category: newCategory,
                    subcategory: newSubcategory,
                    icon: 'fas fa-exclamation-circle'
                };
            }
            
            // Обновляем данные аварий
            allAlarms.forEach(alarm => {
                if (alarm.alarmId === alarmId) {
                    alarm.category = newCategory;
                    alarm.subcategory = newSubcategory;
                    
                    const alarmType = alarmTypeMapping[alarmId] || alarmTypeMapping['default'];
                    alarm.icon = alarmType.icon;
                    // alarmName остается оригинальным
                }
            });
        }
        
        // Загрузка сохраненных настроек
        function loadSavedSettings() {
            // Инициализируем маппинг значениями по умолчанию
            alarmTypeMapping = JSON.parse(JSON.stringify(defaultAlarmTypeMapping));
            
            const savedMapping = localStorage.getItem('alarmTypeMapping');
            if (savedMapping) {
                try {
                    const parsedMapping = JSON.parse(savedMapping);
                    
                    // Объединяем с дефолтными
                    Object.keys(parsedMapping).forEach(alarmId => {
                        if (parsedMapping[alarmId]) {
                            alarmTypeMapping[alarmId] = {
                                ...(alarmTypeMapping[alarmId] || {}),
                                ...parsedMapping[alarmId]
                            };
                        }
                    });
                } catch (e) {
                    console.error('Ошибка загрузки настроек:', e);
                }
            }
        }
        
        // Сохранение настроек
        function saveSettings() {
            try {
                const userSettings = {};
                
                Object.keys(alarmTypeMapping).forEach(alarmId => {
                    const defaultEntry = defaultAlarmTypeMapping[alarmId];
                    const currentEntry = alarmTypeMapping[alarmId];
                    
                    if (!defaultEntry || 
                        currentEntry.category !== defaultEntry.category || 
                        currentEntry.subcategory !== defaultEntry.subcategory ||
                        alarmId === 'default') {
                        userSettings[alarmId] = {
                            name: currentEntry.name,
                            category: currentEntry.category,
                            subcategory: currentEntry.subcategory,
                            icon: currentEntry.icon || 'fas fa-exclamation-circle'
                        };
                    }
                });
                
                localStorage.setItem('alarmTypeMapping', JSON.stringify(userSettings));
            } catch (e) {
                console.error('Ошибка сохранения настроек:', e);
            }
        }
        
        // Сброс категорий к умолчанию
        function resetCategories() {
            if (confirm('Вы уверены, что хотите сбросить все настройки категорий к значениям по умолчанию?')) {
                alarmTypeMapping = JSON.parse(JSON.stringify(defaultAlarmTypeMapping));
                localStorage.removeItem('alarmTypeMapping');
                
                // Обновляем данные аварий
                allAlarms.forEach(alarm => {
                    const alarmType = alarmTypeMapping[alarm.alarmId] || alarmTypeMapping['default'];
                    alarm.category = alarmType.category;
                    alarm.subcategory = alarmType.subcategory;
                    alarm.icon = alarmType.icon;
                    // alarmName остается оригинальным
                });
                
                // Обновляем отображение
                updateAlarmAnalysis();
                renderConstructor();
                initDragAndDrop();
                
                showMessage('Настройки сброшены к значениям по умолчанию', 'success');
            }
        }
        
        // ===================== ЭКСПОРТ =====================
        
        // Экспорт в Excel
        function exportToExcel(tableId, fileName) {
            const table = document.getElementById(tableId);
            if (!table || !table.querySelector('table')) {
                showMessage('Таблица не найдена', 'error');
                return;
            }
            
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.table_to_sheet(table.querySelector('table'));
                XLSX.utils.book_append_sheet(wb, ws, 'Данные');
                
                const exportFileName = `${fileName}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, exportFileName);
                
                showMessage(`Файл "${exportFileName}" успешно экспортирован`, 'success');
            } catch (error) {
                console.error('Ошибка при экспорте:', error);
                showMessage(`Ошибка при экспорте: ${error.message}`, 'error');
            }
        }
        
        // Экспорт всех данных
        function exportAllData() {
            if (allAlarms.length === 0) {
                showMessage('Нет данных для экспорта', 'error');
                return;
            }
            
            try {
                showLoader(true);
                const wb = XLSX.utils.book_new();
                const now = new Date();
                
                // Лист 1: Все аварии
                const alarmsData = allAlarms.map(alarm => {
                    const bsInfo = bbuInfoMap[alarm.bbuName];
                    return {
                        'Регион': getRegionFromBBU(alarm.bbuName) || '',
                        'Site name': alarm.bbuName,
                        'Alarm ID': alarm.alarmId,
                        'Alarm Name': alarm.alarmName, // Оригинальное название
                        'Severity': alarm.severity,
                        'Категория': alarm.category,
                        'Подкатегория': alarm.subcategory,
                        'Clearance Status': alarm.clearanceStatus,
                        'First Occurred': formatDateTime(alarm.firstOccurred),
                        'Last Occurred': formatDateTime(alarm.lastOccurred),
                        'Cleared On': formatDateTime(alarm.clearedOn),
                        'Alarm Source': alarm.alarmSource,
                        'Subnet': alarm.subnet,
                        'NE Type': alarm.neType,
                        'MO Name': alarm.moName,
                        'Location': alarm.location,
                        'Cell Name': alarm.cellName,
                        'RRU Name': alarm.rruName,
                        'ЦЭ': bsInfo?.center || '',
                        'Адрес расположения': bsInfo?.address || '',
                        'KAT TS': bsInfo?.category || '',
                        'Вид трансмиссии': bsInfo?.transportType || '',
                        'Операционный статус': bsInfo?.operationalStatus || ''
                    };
                });
                
                const alarmsWs = XLSX.utils.json_to_sheet(alarmsData);
                XLSX.utils.book_append_sheet(wb, alarmsWs, 'Все аварии');
                
                // Лист 2: Статистика
                const stats = generateBBUStatisticsWithDetails();
                const statsData = stats.map(stat => ({
                    'Site name': stat.bbuName,
                    'Регион': stat.region,
                    'ЦЭ': stat.center,
                    'KAT TS': stat.category,
                    'Общий простой': stat.totalDowntimeFormatted,
                    'Работа на АКБ (всего)': stat.batteryDurationTotalFormatted,
                    'Работа на АКБ (средняя)': stat.batteryDurationAvgFormatted,
                    'Работа на АКБ (максимальная)': stat.batteryDurationMaxFormatted,
                    'Кол-во отключений': stat.disconnectionCount,
                    'Причина отключения': stat.disconnectionReason,
                    'Всего аварий': stat.totalEvents,
                    'Активные аварии': stat.unclearedEvents
                }));
                
                const statsWs = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, statsWs, 'Статистика');
                
                // Сохраняем файл
                const fileName = `Анализ_БС_${now.toISOString().slice(0, 10)}_${now.getHours()}${now.getMinutes()}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage(`Файл "${fileName}" успешно экспортирован`, 'success');
            } catch (error) {
                console.error('Ошибка при экспорте всех данных:', error);
                showMessage(`Ошибка при экспорте: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        // Экспорт в KML
        function exportToKML() {
            if (!bbuInfoMap || Object.keys(bbuInfoMap).length === 0) {
                showMessage('Нет данных с координатами для экспорта в KML', 'error');
                return;
            }
            
            try {
                showLoader(true);
                const kmlContent = generateKML();
                if (!kmlContent) {
                    showMessage('Нет данных с координатами для экспорта в KML', 'error');
                    return;
                }
                
                const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `БС_карта_${new Date().toISOString().slice(0, 10)}.kml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('KML файл успешно экспортирован', 'success');
            } catch (error) {
                console.error('Ошибка при экспорте в KML:', error);
                showMessage(`Ошибка при экспорте: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        // Генерация KML
        function generateKML() {
            let totalWithCoords = 0;
            let workingCount = 0;
            let notWorkingCount = 0;
            let batteryCount = 0;
            
            // Получаем список БС на батарейках
            const batteryBSList = getBatteryBS();
            const batteryBSSet = new Set(batteryBSList.map(bs => bs.bbuName));
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>Базовая станции</name>
<description>Карта базовых станций</description>

<Style id="bs-working">
<IconStyle>
<color>ff00ff00</color>
<scale>1.2</scale>
<Icon>
<href>http://maps.google.com/mapfiles/kml/pushpin/grn-pushpin.png</href>
</Icon>
</IconStyle>
</Style>

<Style id="bs-not-working">
<IconStyle>
<color>ff0000ff</color>
<scale>1.2</scale>
<Icon>
<href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href>
</Icon>
</IconStyle>
</Style>

<Style id="bs-battery">
<IconStyle>
<color>ff00aaff</color>
<scale>1.4</scale>
<Icon>
<href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
</Icon>
</IconStyle>
</Style>

<Style id="bs-unknown">
<IconStyle>
<color>ff888888</color>
<scale>1.0</scale>
<Icon>
<href>http://maps.google.com/mapfiles/kml/pushpin/wht-pushpin.png</href>
</Icon>
</IconStyle>
</Style>
`;
            
            // Добавляем метки для каждой БС
            Object.entries(bbuInfoMap).forEach(([bbuName, info]) => {
                if (info.latitude === undefined || info.longitude === undefined || 
                    isNaN(info.latitude) || isNaN(info.longitude)) return;
                
                // Проверяем операционный статус
                if (!info.operationalStatus) return;
                const status = info.operationalStatus.toString().trim();
                if (!VALID_OPERATIONAL_STATUSES.some(validStatus => status.includes(validStatus))) {
                    return; // Пропускаем БС с недопустимым статусом
                }
                
                totalWithCoords++;
                
                // Проверяем, находится ли БС на батарейках
                const isOnBattery = batteryBSSet.has(bbuName);
                const bsStatus = getBSStatusDetailed(bbuName);
                const isWorking = bsStatus === 'working';
                
                if (isOnBattery) batteryCount++;
                else if (isWorking) workingCount++;
                else notWorkingCount++;
                
                const region = getRegionFromBBU(bbuName);
                const center = info.center;
                const category = info.category;
                const address = info.address;
                
                // Выбираем стиль в зависимости от статуса
                let styleId;
                if (isOnBattery) {
                    styleId = 'bs-battery';
                } else {
                    styleId = isWorking ? 'bs-working' : 'bs-not-working';
                }
                
                const description = `
<b>${escapeHtml(bbuName)}</b><br/>
<b>Состояние:</b> ${isOnBattery ? 'БС на батарейках' : (isWorking ? 'БС работает' : 'БС не работает')}<br/>
<b>Регион:</b> ${escapeHtml(region || 'Не определен')}<br/>
<b>ЦЭ:</b> ${escapeHtml(center || 'Не указан')}<br/>
<b>KAT TS:</b> ${escapeHtml(category || 'Не указана')}<br/>
<b>Адрес расположения:</b> ${escapeHtml(address || 'Не указан')}<br/>
<b>Признак:</b> ${escapeHtml(info.bsType || 'Не указан')}<br/>
<b>Вид трансмиссии:</b> ${escapeHtml(info.transportType || 'Не указан')}<br/>
<b>Емкость АКБ:</b> ${info.batteryCapacity || '180'} мин<br/>
<b>Операционный статус:</b> ${escapeHtml(info.operationalStatus || 'Не указан')}<br/>
<b>Координаты:</b> ${info.latitude.toFixed(6)}, ${info.longitude.toFixed(6)}
`;
                
                kml += `
<Placemark>
<name>${escapeHtml(bbuName)}</name>
<description><![CDATA[${description}]]></description>
<styleUrl>#${styleId}</styleUrl>
<Point>
<coordinates>${info.longitude},${info.latitude},0</coordinates>
</Point>
</Placemark>
`;
            });
            
            if (totalWithCoords === 0) return null;
            
            kml += `
<description><![CDATA[
<b>Статистика по карте:</b><br/>
Всего БС с координатами: ${totalWithCoords}<br/>
БС в работе: ${workingCount}<br/>
БС на батарейках: ${batteryCount}<br/>
БС не работает: ${notWorkingCount}<br/>
<br/>
<b>Обозначения:</b><br/>
<img src="http://maps.google.com/mapfiles/kml/pushpin/grn-pushpin.png" width="20" height="32"/> - БС в работе<br/>
<img src="http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png" width="20" height="32"/> - БС на батарейках<br/>
<img src="http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png" width="20" height="32"/> - БС не работает
]]></description>
</Document>
</kml>`;
            
            return kml;
        }
        
        // Экспорт данных мониторинга
        function exportMonitoringData() {
            if (!bbuInfoMap || Object.keys(bbuInfoMap).length === 0) {
                showMessage('Нет данных для экспорта', 'error');
                return;
            }
            
            try {
                showLoader(true);
                const wb = XLSX.utils.book_new();
                const now = new Date();
                
                // Получаем отфильтрованные данные
                const selectedRegions = getMultiselectValues('regionFilter');
                const selectedCenters = getMultiselectValues('centerFilter');
                const selectedAlarmTypes = getMultiselectValues('alarmTypeFilter');
                
                const disconnectedBS = getDisconnectedBS();
                const batteryBS = getBatteryBS();
                const noMPFBS = getNoMPFBS();
                
                // Фильтруем данные по выбранным фильтрам
                let filteredDisconnected = disconnectedBS;
                let filteredBattery = batteryBS;
                let filteredNoMPF = noMPFBS;
                
                if (selectedRegions.length > 0) {
                    filteredDisconnected = filteredDisconnected.filter(bs => selectedRegions.includes(bs.region));
                    filteredBattery = filteredBattery.filter(bs => selectedRegions.includes(bs.region));
                    filteredNoMPF = filteredNoMPF.filter(bs => selectedRegions.includes(bs.region));
                }
                
                if (selectedCenters.length > 0) {
                    filteredDisconnected = filteredDisconnected.filter(bs => selectedCenters.includes(bs.center));
                    filteredBattery = filteredBattery.filter(bs => selectedCenters.includes(bs.center));
                    filteredNoMPF = filteredNoMPF.filter(bs => selectedCenters.includes(bs.center));
                }
                
                if (selectedAlarmTypes.length > 0) {
                    if (!selectedAlarmTypes.includes('disconnected')) {
                        filteredDisconnected = [];
                    }
                    if (!selectedAlarmTypes.includes('battery')) {
                        filteredBattery = [];
                    }
                    if (!selectedAlarmTypes.includes('no-mpf')) {
                        filteredNoMPF = [];
                    }
                }
                
                // Лист 1: Лежащие БС
                const disconnectedWS = XLSX.utils.json_to_sheet(filteredDisconnected.map(bs => ({
                    'BBU Name': bs.bbuName,
                    'Регион': bs.region,
                    'ЦЭ': bs.center,
                    'KAT TS': bs.category,
                    'Адрес': bs.address,
                    'Время возникновения': formatDateTime(bs.occurred),
                    'Длительность': bs.durationFormatted,
                    'Статус': bs.clearanceStatus,
                    'За 24ч': bs.isRecent24h ? 'Да' : 'Нет'
                })));
                XLSX.utils.book_append_sheet(wb, disconnectedWS, 'Лежащие БС');
                
                // Лист 2: БС на батарейках
                const batteryWS = XLSX.utils.json_to_sheet(filteredBattery.map(bs => ({
                    'BBU Name': bs.bbuName,
                    'Регион': bs.region,
                    'ЦЭ': bs.center,
                    'KAT TS': bs.category,
                    'Адрес': bs.address,
                    'Начало MPF': formatDateTime(bs.mpfStart),
                    'Начало работы от АКБ': formatDateTime(bs.batteryStart),
                    'Длительность работы от АКБ': bs.batteryDurationFormatted,
                    'Оставшееся время АКБ': bs.remainingFormatted,
                    'Процент использования АКБ': bs.percentage.toFixed(1) + '%',
                    'Критический уровень': bs.isCritical ? 'Да' : 'Нет'
                })));
                XLSX.utils.book_append_sheet(wb, batteryWS, 'БС на батарейках');
                
                // Лист 3: БС без MPF
                const noMPFWS = XLSX.utils.json_to_sheet(filteredNoMPF.map(bs => ({
                    'BBU Name': bs.bbuName,
                    'Регион': bs.region,
                    'ЦЭ': bs.center,
                    'KAT TS': bs.category,
                    'Адрес': bs.address,
                    'Время возникновения': formatDateTime(bs.occurred),
                    'Длительность': bs.durationFormatted,
                    'Статус': bs.clearanceStatus
                })));
                XLSX.utils.book_append_sheet(wb, noMPFWS, 'БС без MPF');
                
                const fileName = `Мониторинг_БС_${now.toISOString().slice(0, 10)}_${now.getHours()}${now.getMinutes()}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage(`Файл "${fileName}" успешно экспортирован`, 'success');
            } catch (error) {
                console.error('Ошибка при экспорте:', error);
                showMessage(`Ошибка при экспорте: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        // Экспорт отфильтрованных данных в Excel
        function exportFilteredExcel() {
            if (filteredAlarms.length === 0) {
                showMessage('Нет данных для экспорта по текущим фильтрам', 'warning');
                return;
            }
            
            try {
                showLoader(true);
                const wb = XLSX.utils.book_new();
                const now = new Date();
                
                // Создаем данные для экспорта
                const exportData = filteredAlarms.map(alarm => {
                    const bsInfo = bbuInfoMap[alarm.bbuName];
                    return {
                        'Регион': getRegionFromBBU(alarm.bbuName) || '',
                        'Site name': alarm.bbuName,
                        'Alarm ID': alarm.alarmId,
                        'Alarm Name': alarm.alarmName, // Оригинальное название
                        'Severity': alarm.severity,
                        'Категория': alarm.category,
                        'Подкатегория': alarm.subcategory,
                        'Clearance Status': alarm.clearanceStatus,
                        'First Occurred': formatDateTime(alarm.firstOccurred),
                        'Last Occurred': formatDateTime(alarm.lastOccurred),
                        'Cleared On': formatDateTime(alarm.clearedOn),
                        'Alarm Source': alarm.alarmSource,
                        'Subnet': alarm.subnet,
                        'NE Type': alarm.neType,
                        'MO Name': alarm.moName,
                        'Location': alarm.location,
                        'Cell Name': alarm.cellName,
                        'RRU Name': alarm.rruName,
                        'ЦЭ': bsInfo?.center || '',
                        'Адрес расположения': bsInfo?.address || '',
                        'KAT TS': bsInfo?.category || '',
                        'Вид трансмиссии': bsInfo?.transportType || '',
                        'Операционный статус': bsInfo?.operationalStatus || ''
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, 'Отфильтрованные аварии');
                
                const fileName = `Аварии_фильтр_${now.toISOString().slice(0, 10)}_${now.getHours()}${now.getMinutes()}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showMessage(`Файл "${fileName}" успешно экспортирован`, 'success');
            } catch (error) {
                console.error('Ошибка при экспорте:', error);
                showMessage(`Ошибка при экспорте: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        // Функция для экранирования HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Глобальные функции для использования в HTML
        window.toggleBSList = toggleBSList;
        window.toggleCategoryContainer = toggleCategoryContainer;
        window.toggleAlarmsContainer = toggleAlarmsContainer;
        window.updateMonitoring = updateMonitoring;
        window.updateAlarmAnalysis = updateAlarmAnalysis;
        window.updateMap = updateMap;
        window.exportToExcel = exportToExcel;
        window.exportToKML = exportToKML;
        window.exportFilteredExcel = exportFilteredExcel;
        window.exportMonitoringData = exportMonitoringData;
        window.showFilteredOnMap = showFilteredOnMap;
        window.showMonitoringOnMap = showMonitoringOnMap;
        window.showAllBSOnMap = showAllBSOnMap;
        window.clearMapSelection = clearMapSelection;
        window.toggleMultiselect = toggleMultiselect;
        window.toggleMultiselectItem = toggleMultiselectItem;
        window.removeMultiselectItem = removeMultiselectItem;
        window.selectAllMultiselect = selectAllMultiselect;
        window.clearMultiselect = clearMultiselect;
        window.searchBSOnMap = searchBSOnMap;
        
        // ===================== КОНСТРУКТОР ИНФОРМАЦИИ ПО БС =====================
        
        // Открытие конструктора информации по БС
        function openBSInfoConstructor() {
            if (Object.keys(bbuInfoMap).length === 0) {
                showMessage('Сначала загрузите файл информации о БС', 'error');
                return;
            }
            
            const modal = document.getElementById('bsInfoConstructorModal');
            modal.style.display = 'block';
            
            // Заполняем конструктор
            renderBSInfoConstructor();
            
            // Инициализируем drag and drop
            initBSInfoDragAndDrop();
        }
        
        // Закрытие конструктора информации по БС
        function closeBSInfoConstructor() {
            const modal = document.getElementById('bsInfoConstructorModal');
            modal.style.display = 'none';
        }
        
        // Рендеринг конструктора информации по БС
        function renderBSInfoConstructor() {
            // Получаем все возможные поля из bbuInfoMap
            const allFields = new Set();
            Object.values(bbuInfoMap).forEach(info => {
                Object.keys(info).forEach(key => allFields.add(key));
            });
            
            // Добавляем специальное поле статуса БС
            allFields.add('bsStatus');
            
            // Получаем сохраненные настройки или используем значения по умолчанию
            const savedSettings = localStorage.getItem('bsInfoFieldsConfig');
            let selectedFields = ['bbuName', 'center', 'address', 'category', 'operationalStatus']; // Поля по умолчанию
            let availableFields = [];
            
            if (savedSettings) {
                try {
                    const config = JSON.parse(savedSettings);
                    selectedFields = config.selected || selectedFields;
                    availableFields = Array.from(allFields).filter(field => !selectedFields.includes(field));
                } catch (e) {
                    console.error('Ошибка загрузки настроек конструктора информации по БС:', e);
                    availableFields = Array.from(allFields).filter(field => !selectedFields.includes(field));
                }
            } else {
                availableFields = Array.from(allFields).filter(field => !selectedFields.includes(field));
            }
            
            // Заполняем доступные поля
            const availableList = document.getElementById('availableFieldsList');
            availableList.innerHTML = '';
            availableFields.forEach(field => {
                const fieldItem = createFieldItem(field, 'available');
                availableList.appendChild(fieldItem);
            });
            
            // Заполняем отображаемые поля
            const selectedList = document.getElementById('selectedFieldsList');
            selectedList.innerHTML = '';
            selectedFields.forEach(field => {
                const fieldItem = createFieldItem(field, 'selected');
                selectedList.appendChild(fieldItem);
            });
        }
        
        // Создание элемента поля
        function createFieldItem(fieldName, category) {
            const fieldItem = document.createElement('div');
            fieldItem.className = 'bs-info-field-item';
            fieldItem.draggable = true;
            fieldItem.dataset.fieldName = fieldName;
            
            // Преобразуем имя поля в читаемый формат
            const displayName = getReadableFieldName(fieldName);
            
            fieldItem.innerHTML = `
                <span class="field-name">${escapeHtml(displayName)}</span>
                <div class="field-actions">
                    <button class="field-action-btn move-${category === 'available' ? 'right' : 'left'}"
                            onclick="moveField('${fieldName}', '${category}')">
                        <i class="fas fa-${category === 'available' ? 'arrow-right' : 'arrow-left'}"></i>
                    </button>
                </div>
            `;
            
            // Добавляем обработчики drag and drop
            fieldItem.addEventListener('dragstart', handleFieldDragStart);
            fieldItem.addEventListener('dragover', handleFieldDragOver);
            fieldItem.addEventListener('dragenter', handleFieldDragEnter);
            fieldItem.addEventListener('dragleave', handleFieldDragLeave);
            fieldItem.addEventListener('drop', handleFieldDrop);
            fieldItem.addEventListener('dragend', handleFieldDragEnd);
            
            return fieldItem;
        }
        
        // Преобразование имени поля в читаемый формат
        function getReadableFieldName(fieldName) {
            const fieldNamesMap = {
                'bbuName': 'Site name',
                'address': 'Адрес расположения',
                'category': 'KAT TS',
                'transportType': 'Вид трансмиссии',
                'center': 'ЦЭ',
                'bsType': 'Признак',
                'batteryCapacity': 'Емкость АКБ (мин)',
                'latitude': 'Широта',
                'longitude': 'Долгота',
                'operationalStatus': 'Операционный статус',
                'bsStatus': 'Статус БС'
            };
            
            return fieldNamesMap[fieldName] || fieldName;
        }
        
        // Перемещение поля между списками
        function moveField(fieldName, fromCategory) {
            const availableList = document.getElementById('availableFieldsList');
            const selectedList = document.getElementById('selectedFieldsList');
            
            if (fromCategory === 'available') {
                // Перемещаем из доступных в отображаемые
                const fieldItem = document.querySelector(`.bs-info-field-item[data-field-name="${fieldName}"]`);
                if (fieldItem) {
                    availableList.removeChild(fieldItem);
                    selectedList.appendChild(fieldItem);
                    
                    // Обновляем классы для нового положения
                    fieldItem.querySelector('.move-available').outerHTML =
                        `<button class="field-action-btn move-selected" onclick="moveField('${fieldName}', 'selected')">
                            <i class="fas fa-arrow-left"></i>
                        </button>`;
                }
            } else {
                // Перемещаем из отображаемых в доступные
                const fieldItem = document.querySelector(`.bs-info-field-item[data-field-name="${fieldName}"]`);
                if (fieldItem) {
                    selectedList.removeChild(fieldItem);
                    availableList.appendChild(fieldItem);
                    
                    // Обновляем классы для нового положения
                    fieldItem.querySelector('.move-selected').outerHTML =
                        `<button class="field-action-btn move-available" onclick="moveField('${fieldName}', 'available')">
                            <i class="fas fa-arrow-right"></i>
                        </button>`;
                }
            }
        }
        
        // Drag and Drop переменные
        let draggedField = null;
        
        // Обработчик начала перетаскивания
        function handleFieldDragStart(e) {
            draggedField = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.fieldName);
            this.classList.add('dragging');
        }
        
        // Обработчик над элементом во время перетаскивания
        function handleFieldDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        // Обработчик входа над элементом
        function handleFieldDragEnter(e) {
            this.classList.add('drag-over');
        }
        
        // Обработчик выхода с элемента
        function handleFieldDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        // Обработчик сброса элемента
        function handleFieldDrop(e) {
            e.stopPropagation();
            this.classList.remove('drag-over');
            
            if (draggedField && draggedField !== this) {
                // Определяем, в какой список мы сбрасываем
                const targetList = this.closest('.bs-info-field-list');
                const sourceList = draggedField.closest('.bs-info-field-list');
                
                // Если списки разные, перемещаем элемент
                if (targetList !== sourceList) {
                    targetList.appendChild(draggedField);
                    
                    // Обновляем кнопку действия в зависимости от нового списка
                    const fieldName = draggedField.dataset.fieldName;
                    const button = draggedField.querySelector('.field-action-btn');
                    if (targetList.id === 'selectedFieldsList') {
                        button.className = 'field-action-btn move-selected';
                        button.onclick = () => moveField(fieldName, 'selected');
                        button.innerHTML = '<i class="fas fa-arrow-left"></i>';
                    } else {
                        button.className = 'field-action-btn move-available';
                        button.onclick = () => moveField(fieldName, 'available');
                        button.innerHTML = '<i class="fas fa-arrow-right"></i>';
                    }
                }
            }
            
            return false;
        }
        
        // Обработчик окончания перетаскивания
        function handleFieldDragEnd(e) {
            document.querySelectorAll('.bs-info-field-item').forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });
            draggedField = null;
        }
        
        // Инициализация drag and drop для конструктора информации по БС
        function initBSInfoDragAndDrop() {
            const availableList = document.getElementById('availableFieldsList');
            const selectedList = document.getElementById('selectedFieldsList');
            
            // Добавляем обработчики для списков
            [availableList, selectedList].forEach(list => {
                list.addEventListener('dragover', handleFieldDragOver);
                list.addEventListener('dragenter', handleFieldDragEnter);
                list.addEventListener('dragleave', handleFieldDragLeave);
                list.addEventListener('drop', handleFieldDrop);
            });
        }
        
        // Сохранение настроек полей информации по БС
        function saveBSInfoFields() {
            const selectedList = document.getElementById('selectedFieldsList');
            const selectedItems = selectedList.querySelectorAll('.bs-info-field-item');
            const selectedFields = Array.from(selectedItems).map(item => item.dataset.fieldName);
            
            try {
                const config = {
                    selected: selectedFields,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('bsInfoFieldsConfig', JSON.stringify(config));
                showMessage('Настройки информации по БС сохранены', 'success');
            } catch (e) {
                console.error('Ошибка сохранения настроек конструктора информации по БС:', e);
                showMessage('Ошибка при сохранении настроек', 'error');
            }
        }
        
        // Сброс настроек полей информации по БС к умолчанию
        function resetBSInfoFields() {
            if (confirm('Вы уверены, что хотите сбросить настройки полей информации по БС к значениям по умолчанию?')) {
                localStorage.removeItem('bsInfoFieldsConfig');
                renderBSInfoConstructor();
                showMessage('Настройки полей информации по БС сброшены к умолчанию', 'success');
            }
        }
        
        // Обновление таблицы информации по БС с учетом выбранных полей
        function updateBSInfoTableWithFields() {
            const savedSettings = localStorage.getItem('bsInfoFieldsConfig');
            let displayedFields = ['bbuName', 'center', 'address', 'category', 'operationalStatus']; // Поля по умолчанию
            
            if (savedSettings) {
                try {
                    const config = JSON.parse(savedSettings);
                    displayedFields = config.selected || displayedFields;
                } catch (e) {
                    console.error('Ошибка загрузки настроек конструктора информации по БС:', e);
                }
            }
            
            // Получаем данные для таблицы
            const bsInfoArray = Object.values(bbuInfoMap).filter(info => {
                if (!info.operationalStatus) return false;
                const status = info.operationalStatus.toString().trim();
                return VALID_OPERATIONAL_STATUSES.some(validStatus =>
                    status.includes(validStatus)
                );
            });
            
            if (bsInfoArray.length === 0) {
                document.getElementById('bsInfoTable').innerHTML = '<div class="no-data"><p>Нет информации о БС</p></div>';
                return;
            }
            
            // Создаем заголовки таблицы
            let headersHTML = '<tr>';
            displayedFields.forEach(field => {
                const displayName = getReadableFieldName(field);
                headersHTML += `<th>${escapeHtml(displayName)}</th>`;
            });
            headersHTML += '</tr>';
            
            // Создаем строки таблицы
            let rowsHTML = '';
            bsInfoArray.forEach(info => {
                let rowHTML = '<tr>';
                displayedFields.forEach(field => {
                    // Если поле - это специальное поле статуса, то вычисляем его
                    if (field === 'bsStatus') {
                        const bsStatus = getBSStatusDetailed(info.bbuName);
                        const statusText = bsStatus === 'battery' ? 'БС на батарейках' :
                                         bsStatus === 'not_working' ? 'БС не работает' : 'БС работает';
                        rowHTML += `<td>${statusText}</td>`;
                    } else {
                        const value = info[field] !== undefined ? info[field] : '';
                        rowHTML += `<td>${escapeHtml(value.toString() || 'N/A')}</td>`;
                    }
                });
                rowHTML += '</tr>';
                rowsHTML += rowHTML;
            });
            
            // Формируем полную таблицу
            const tableHTML = `
                <table>
                    <thead>
                        ${headersHTML}
                    </thead>
                    <tbody>
                        ${rowsHTML}
                    </tbody>
                </table>
            `;
            
            document.getElementById('bsInfoTable').innerHTML = `<div class="table-scroll-container">${tableHTML}</div>`;
        }
        
        // Инициализация обработчиков событий для конструктора информации по БС
        document.getElementById('bsInfoConstructorBtn').addEventListener('click', openBSInfoConstructor);
        document.getElementById('closeBSInfoConstructorBtn').addEventListener('click', closeBSInfoConstructor);
        document.getElementById('cancelBSInfoConstructorBtn').addEventListener('click', closeBSInfoConstructor);
        document.getElementById('saveBSInfoFieldsBtn').addEventListener('click', function() {
            saveBSInfoFields();
            closeBSInfoConstructor();
            // Обновляем таблицу информации по БС
            updateBSInfoTableWithFields();
        });
        document.getElementById('resetBSInfoFieldsBtn').addEventListener('click', resetBSInfoFields);
        
        console.log('Универсальный анализатор логов БС инициализирован (версия 2.5 - исправленная)');
    </script>
</body>
</html>